## Eventual Consistency 최종 일관성, 결과적 일관성
### 관련 개념
- Consistency (일관성)
    - 일관성이란 클러스터 내 모든 노드가 동일한 데이터를 가지고 있음을 의미한다. 일관성을 만족하기 위해서는 데이터가 하나의 노드에 기록될 때마다 클러스터의 모든 노드로 데이터가 복제되어야 한다. 따라서 트랜잭션이 끝나기 전에 모든 노드로 데이터의 전파가 이뤄져야 한다.
    - 일관성이 만족될 때 클러스터 내 모든 노드는 "언제나" 동일한 데이터를 가지고 있음이 보장되고, 클라이언트는 어떤 노드에 접근해도 일관된 데이터를 받을 수 있음이 보장된다.
- CAP 정리는 분산 시스템에서 일관성(consistency), 가용성(availability), 파티션 내성(partition tolerance) 중 두 가지를 동시에 만족시킬 수 없다는 이론이다. 최종 일관성은 이 정리를 활용하여 일관성과 가용성 간의 균형을 맞추는 접근 방식이다.

### Eventual Consistency 최종 일관성, 결과적 일관성
- 분산 시스템에서 모든 노드가 즉시 동일한 데이터를 가지지는 않지만, 일정 시간이 지나면 결국에는 같은 상태로 수렴하게 되는 일관성 모델이다.최종 일관성은 분산 시스템에서 데이터가 일시적으로 일관되지 않을 수 있지만, 결국 모든 노드가 동일한 상태를 가지게 되는 모델로. 이는 확장 가능하고 높은 가용성이 요구되는 시스템에서 널리 사용된다. 즉,시스템의 한 부분에서 무언가를 업데이트하면 모든 다른 위치에서 그 변화를 볼 때까지 시간이 걸릴 수 있지만, 결국에는 그 변화가 전파된다는 것이다.
- 분산 시스템에서는 성능과 가용성을 높이기 위해 데이터가 여러 서버(노드)에 복제된다. 그런데 네트워크 지연이나 장애 등으로 인해 모든 노드가 동시에 같은 데이터를 반영하는 것이 어려운 경우가 많다. 그래서 강한 일관성(strong consistency)을 포기하고, 일시적으로 불일치하더라도 언젠가는 일치할 거라는 전제하에 시스템을 구성하는 것이 Eventual Consistency이다.
- 분산 시스템 설계 시 고려하는 CAP 이론에서 ‘C(Consistency)’에 해당하는 선택지 중 하나
- 최종적 일관성 모델은 금융 시스템과 같이 엄격한 일관성이 요구되는 시스템에서 적합하지 않다.

### 장점
- 일부 복제본이 일시적으로 동기화되지 않는 경우에도 높은 가용성을 제공한다.
- 쓰기 작업에서 낮은 레이턴시를 보여줍니다.

### 단점
- 일시적으로 일부 노드가 오래된 값을 반환할 수 있다. (일시적으로 일관성 깨짐)
- 데이터 충돌 발생 시 복잡한 해결 전략으로 인해 충돌이 발생할 경우 데이터 손실이 발생할 수 있다.

### 최종 일관성을 사용하는 이유
- 성능 향상: 즉각적인 노드 간 동기화를 기다릴 필요가 없어 지연 시간이 줄어든다.
- 높은 가용성: 통신 장애가 발생해도 시스템이 계속 작동할 수 있다.
- 확장성: 각 노드가 독립적으로 작동할 수 있어 더 많은 작업 부하를 처리할 수 있다.

## 예시 
- 어떤 사용자가 블로그 글을 작성했을 때, 1번 서버에는 바로 반영되지만, 3번 서버에는 2초 후에 반영됨. 사용자는 지역적으로 가까운 서버에서 빠르게 읽을 수 있지만, 초기엔 최신 글이 보이지 않을 수 있음. 시간이 지나면 3번 서버도 1번과 동일한 데이터를 가지게 됨 → 결국 "Eventual"하게 일관됨.
- 소셜 네트워크를 예로 들자면, 누군가가 게시물을 좋아요 하면, 친구들은 거의 즉시 그 업데이트를 볼 수 있다. 그러나 다른 지역에 있는 친구는 데이터 복제 때문에 몇 초 후에야 그 변화를 볼 수 있다. 이러한 짧은 지연은 사용자 경험에 크게 영향을 미치지 않는다.

## 사용사례 
- SNS 피드처럼 즉각적인 정합성보다 빠른 응답과 고가용성이 중요한 경우
- 대규모 분산 환경에서 네트워크 지연을 감수하고 가용성을 최우선시할 때
- 모든 시스템이 최종 일관성을 사용할 수 있는 것은 아니다. 금융 거래와 같이 데이터의 정확성이 절대적으로 필요한 시스템에서는 강한 일관성(strong consistency)이 필수적이다. 이러한 경우, 모든 노드가 즉시 일관성을 유지해야 하기때문에 최종 일관성을 쓸 수 없다.


## Strong Consistency 강한 일관성
- 연산 후에 바로 모든 복제본이 같은 값을 가지고 있음을 보장하는 일관성 모델으로 시스템 내 데이터의 '최신성(Timeliness)'과 '무결성(Integrity)'을 보장하는 것을 의미한다.
- 분산 시스템에서 이는 모든 마이크로서비스가 데이터를 '즉시' 그리고 '정확하게' 업데이트하는 것을 말하며 데이터베이스 시스템에서는 원본 데이터가 업데이트된 직후 복제 데이터도 동일하게 업데이트 되어진 것을 의미한다.
- 어떤 클라이언트가 데이터를 읽을 때, 항상 가장 최신의 데이터를 읽을 수 있음을 보장하는 모델. 즉, 어떤 노드에서든 데이터를 읽을 때 직전에 기록(write)된 값이 반드시 반영되어 있어야 한다는 의미다.
- 강력한 일관성은 데이터 무결성 유지에 중요한 역할을 하며 분산 데이터베이스, 트랜잭션 시스템 및 분석 플랫폼에서 일반적으로 사용됩니다.

### 특징
- 보장된 작업 순서: 모든 작업이 조정된 순서대로 수행되고 모든 노드가 작업 순서에 동의하도록 보장한다.
- 동기화된 데이터: 모든 복제본에는 최신 데이터가 있으므로 정확하고 최신의 읽기 및 쓰기 작업이 보장된다.
- 높은 데이터 무결성: 데이터 손상이나 불일치 위험을 줄여주며, 이는 임무 수행에 중요한 애플리케이션과 엄격한 데이터 요구 사항이 있는 기업에 필수적이다.

### 장점
- 사용자에게 항상 최신의 일관된 데이터를 제공함으로써 데이터 무결성이 보장된다.
- 향상된 데이터 신뢰성: 데이터가 항상 정확하고 최신 상태인지 확인합니다. 이는 실시간 분석 과 의사 결정에 의존하는 기업에 매우 중요합니다.
- 강화된 데이터 보안: 모든 복제본에서 일관된 상태를 유지하여 데이터 손상 및 손실을 방지하고, 무단 변경이나 불일치를 방지합니다.
- 더 나은 사용자 경험: 사용자에게 시스템과의 예측 가능하고 일관된 상호작용을 제공하고, 데이터 불일치로 인해 발생하는 예상치 못한 동작이나 오류를 제거합니다.

### 단점
- 항상 최신 상태의 데이터를 반환해야 하므로 많은 수의 node에게 의존한다. 그러므로 Eventual Consistency를 보장하는 시스템에 비해 Availability은 낮고 Latency는 높다.
- 높은 지연 시간(Latency)이 발생할 수 있으며, 가용성 또는 파티션 내구성과 충돌 가능성이 크다.
- 시스템 성능 저하: 일관성을 유지하는 데 따른 오버헤드는 시스템 성능에 영향을 미칠 수 있으며, 특히 대규모 또는 지리적으로 분산된 환경에서는 더욱 그렇다.
- 지연 시간 증가 가능성: 분산 노드 전체에서 일관성을 유지하면 읽기 및 쓰기 작업에 추가 지연 시간이 발생할 수 있으며, 이는 시간에 민감한 애플리케이션에 영향을 미칠 수 있다.

### 예시 
- 은행 시스템: A 계좌에서 1,000원을 인출했다면, 그 직후에 잔고를 조회할 때는 항상 1,000원이 빠진 최신 잔고가 보여야 한다.

## 사용사례 
- 정확한 데이터가 필수인 경우 (ex 금융, 주문처리, 재고 관리)
- 작은 지연보다 데이터 신뢰성이 더 중요한 상황.


----

참고링크 

https://jinseong-dev.tistory.com/40

https://puddingcamp.com/topics/consistency-in-distributed-systems

https://www.dremio.com/wiki/strong-consistency/