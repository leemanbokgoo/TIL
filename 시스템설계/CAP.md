# CAP

![Image](https://github.com/user-attachments/assets/db126863-9ba2-4189-9f0d-cf2826f78fda)

- CAP 이론은 분산 시스템 설계에서 중요한 개념이다. CAP는 일관성(Consistency), 가용성(Availability), 분할 내성(Partition tolerance)의 약자로, 이 세 가지 속성 중에서 동시에 모두를 만족시킬 수 없다는 이론이다.
- 왜냐하면 일관성은 모든 노드가 동일한 시점의 데이터를 보유해야 한다는 것을 의미하고, 가용성은 모든 요청이 성공적으로 처리될 수 있어야 한다는 것을 의미한다. 분할 내성은 네트워크 분할이 발생해도 시스템이 정상적으로 작동해야 한다는 것을 의미한다.
- 분산 데이터베이스 시스템은 반드시 네트워크 장애나 여러 이유들로 인해 장애가 발생할 수 밖에 없다. CAP 이론에 따르면, 이 세 가지 속성 중 두 가지만을 만족시킬 수 있으며, 어떤 두 가지를 선택하느냐에 따라 시스템의 특성이 결정된다. 이는 분산 시스템을 설계할 때, 시스템의 요구 사항에 따라 적절한 속성을 선택해야한다.
- 예를 들어 두 노드로 이루어진 분산 시스템에서 분할이 생겼을 때 데이터의 일관성을 보장하기란 불가능하다. 그러므로 분할이 생겼더라도 정상적으로 요청을 처리해 일관성을 희생하고 가용성을 높이던지, 잠시 요청 처리를 중단하고 중단된 노드가 재실행될 때까지 기다려 가용성을 희생하고 일관성을 지키는 방법 중 하나를 선택해야 한다. 따라서 NoSQL 데이터베이스는 CP 시스템과 AP 시스템으로 분류된다. CA 시스템은 일반적으로 하나의 노드에서 동작하는 모놀리식 데이터베이스 시스템을 의미한다.

## 일관성 Consistency
- 분산 시스템 하에 동작하는 모든 노드들은 항상 동일한 데이터를 가지고 있어야한다는 의미다. 다시 말해 분산 시스템에 2개의 노드가 동작하고 있다면 둘 중 어디에 요청하든 동일한 데이터가 리턴 된다는 의미다. 2개의 노드 중 어디에 데이터를 생성하던 간에 모두 동기화가 되어야한다. 즉 데이터 생성이 성공적으로 된 것으로 인정하려면 해당 operation의 결과가 다른 모든 노드로 복제돼야한다.
- 전통적인 RDBMS들은 분산 시스템이 아닌 단일 서버를 통해 C를 보장하는 반면 NoSQL 데이터베이스들은 여러개의 노드가 동시에 돌아가기 떄문에 replication lag이 당연히 발생할 수 밖에 없고 따라서 같은 시간에 모든 노드들이 같은 데이터를 가지는 것은 불가능하다. 그렇기에 거의 일치하게 느껴지도록 만드는 것이라고 생각하면 된다.
- 일관성은 금융이나 개인정보와 같이 모든 사용자가 일관성있는 데이터를 조회해야할 때 중요하다. 예를들어 금융 앱을 이용할 때 PC나 스마트폰, 태블릿 또는 어디에서 보든 지 같은 잔고를 확인할 수 있어야 한다.

## 가용성 Availability 
- Availability는 쉽게 말해서 분산 시스템 하에 동작하는 여러 노드 중 하나가 장애가 발생하거나 꺼지더라도 계속해서 데이터베이스에 read, write이 가능해야한다는 것을 의미한다. 항상 서비스가 가능해야한다는 의미로 이해하면 된다.
- 시스템 동작이 얼마나 신뢰성을 갖는 지에 대한 척도 중 하나이다. 시스템에서 언제나 원하는 데이터를 빠르게 가져올 수 있는 지에 대한 내용이다. 서버의 가용성을 늘리기 위해서는 여러 서버를 동시에 운영하고 부하 분산 기술을 적용할 수 있다.

## Partition tolerance 분할 내성
- 시스템이 일시적으로 네트워크의 문제로 인하여 노드가 정지되거나 메시지 전송이 지연되는 상황에서 정상적인 동작을 유지할 수 있어야 한다. 즉, 데이터가 분산 환경에 나누어져 있는 환경에서도 잘 동작하는 것을 의미한다.
- 시스템이 얼마나 견고한지에 대한 특성으로 시스템의 분할 내성을 높이려면, 분산 데이터베이스에서 데이터를 복제하여 다른 노드에서도 데이터에 접근할 수 있고, 복제복 일부가 손상되어도 또 다른 복제본으로 이를 대체할 수 있다.
- 분할이란 노드 간 통신이 끊어지는 것을 의미한다. 즉 한 노드가 다른 노드와 통신할 수 없을 때 분할이 생겼다고 한다. 이는 네트워크 장애나 서버 장애 혹은 다른 이유로 인한 것일 수 있다.
- 분할 허용성이란 시스템 내 분할이 생겼을 때 시스템이 여전히 작동하는 것을 의미한다. 즉 한 노드가 다른 노드와 통신할 수 없을 때, 다른 복제 노드가 사용자 요청에 응답할 수 있어야 한다. 이는 데이터의 복제본을 여러 다른 노드에 저장하여 처리하는 것을 의미한다. 따라서 분할이 생기더라도 복제본으로 부터 데이터를 조회할 수 있다. 분할 허용성은 분산 데이터베이스 시스템에서 필수적이다.
- 네트워크 분할이 발생해도 시스템이 동작을 계속 유지할 수 있는 성질을 의미한다. 예를 들어 노드 간 통신이 끊겼더라도, 각 노드는 자체적으로 요청을 처리할 수 있어야 한다는 것을 말한다. 분산 시스템에서는 네트워크 장애가 언제든 발생할 수 있기 때문에, Partition Tolerance는 사실상 반드시 갖춰야 하는 특성이다.

## 조합
- 일관성과 가용성을 동시에 완벽히 만족하려면 네트워크 장애를 허용하지않아야한다. 네트워크 장애가 절대 일어나지 않는 네트워크 구성은 존재하지않는다. 결국 CAP 이론은 네트워크 파티션 허용은 기본적으로 깔고 시작해야한다. 무조건 P를 선택하고 C와 A 중 하나를 골라야한다.
- CAP 이론 처럼 완벽한 CP, AP 시스템은 없고 대부분 CP와 AP의 어느 중간 쯤에 존재한다. configuration에 따라서 변하는 부분이기도 한다. 또한 이론 자체에 몇가지 한계점이 존재한다. 가장 문제가 되는것이 P에 대한 명확한 정의가 부족하다는 것이다. 이런 문제점을 극복하고자 PACELC 이론이 나왔다.

### CA (Consistency, Availability)
- 일관성과 가용성을 만족하는 데이터베이스 시스템이다. 모든 노드가 일관된 데이터를 유지하고, 데이터 요청에 대해 즉각적인 응답을 보장한다. 단, 네트워크 분할 등의 예기치 않은 장애 상황에서는 분할 내성을 보장하지 못한다.
- 데이터에 대한 강한 신뢰를 주지만 네트워크 문제가 생길 시 전체 시스템 중단으로 이어진다. 그 이유는 여러대 노드중에 하나라도 연결이 끊기면 모든 노드는 일관성과 가용성을 지키기 위해 노드에 접근을 하지 못하게 할것이다.

- 장점 : 데이터의 가용성이 높아져서 시스템이 언제나 사용이 가능하다. 데이터 변경이 한 노드에 일어날 경우 모든 노드에 반영되기 때문에, 데이터의 정합성과 신뢰성을 보장할 수 있다.
- 단점 : 네트워크 지연이 발생할 때 일관성을 유지하기 위해서 모든 노드간의 데이터 동기화 시간이 필요하여 성능에 영향이 미친다. 일부 노드가 장애가 발생할 경우엔 시스템 가용성이 떨어지거나 데이터 일관성에 문제가 발생할 수 있다.
- 사례 : 주로 금융 업무, 거래 처리같은 일관성과 정확성이 중요한 서비스에 적합하다.

### CA 예시
- MySQL은 실질적으로는 설정하기에 따라서 CP 또는 CA에 속할 수 있다. 기본적으로 MySQL을 그냥 사용했을 때는 CA에 속하게된다. 왜나하면 main이 되는 master 노드가 있고 그 노드를 복제해서 사용하는 slave 가 있는 패러다임을 사용하기 때문이다. 이때 MySql은 가용성과 일관성을 만족하게 된다.
- 하지만 MySQL은 cluster 설정을 지원한다. cluster 설정을 하면 MySQL은 CP를 만족하는 시스템이 된다. 왜냐하면 data를 유지할만한 cluster 노드가 존재하지 않으면 cluster는 종료될 것이기 때문이다.

### CP (Consistency, Partition tolerance)
- 일관성과 분할 내성을 모두 보장하는 데이터베이스 시스템이다. 네트워크 분할이 일어나더라도 데이터의 일관성을 유지한다. 단, 일부 노드의 장애로 인해 가용성을 보장하지 못할 수 있다.
- 완벽한 일관성을 갖는 분산 시스템에서 데이터 변경은 존재하는 모든 노드에 복제되어야 완료된다. 이는 가용성과 성능에 크나큰 악영향을 끼친다. 만약 하나의 노드라도 문제가 있으면 트랜잭션은 실패한다. 그리고 노드가 늘어날 수록 지연시간은 길어진다.
- 일관성과 분할 허용을 충족하기 때문에 높은 확장성을 가지고 있다. 어떤 노드에서 문제가 발생하면 해당 노드를 제외시켜 일관성을 유지한다.

- 장점 : 데이터의 일관성을 유지하기 때문에, 데이터 정합성은 높다. 일관성을 유지하기 위해 노드간의 통신이 빈번하게 일어나므로 데이터 손실이 일어날 가능성이 작다.
- 단점 : 어떤 노드에서 문제가 발생하면, 해당 노드를 제외해야하므로 가용성이 떨어진다.데이터 일관성을 위해 추가적인 리소스가 필요하므로 시스템 성능이 저하될 가능성이 크다.

### CP 예시 
- DynamoDB는 기본적으로 AP 시스템이지만 사용자가 "강한 일관성(strong consistency)" 옵션을 설정하면 CP 특성도 가질 수 있다. DynamoDB는 aws에서 지원하는 key/Value의 NoSQL로 AP에 속한다고 알려져있다. Dynamo는 key값을 hashing 하고 또 이 값을 mod하여 맞는 서버에 저장해둔다. 그리고 전체 노드 중 일부 node에 복제해둔다. 그리고 data versioning도 진행한다. DynamoDB에는 strongly consistent 설정을 할 수 있다. 이 설정을 하게 되면 DynamoDB는 CP로 변하게 된다. 이 설정을 하게 되면 가장 최신의 데이터를 반드시 리턴하게 된다. 따라서 모든 노드를 찾기 때문에 가용성은 조금 떨어지게 된다.

### AP (Availability, Partition tolerance)
- 가용성과 분할 내성을 모두 보장하는 데이터베이스 시스템이다. 모든 요청에 대해 즉각적인 응답을 보장하고, 네트워크 분할 상황에서도 응답을 보장한다. 단, 데이터의 일관성이 보장되지 않을 수 있다.
- 시스템이 언제나 가용 가능하며, 네트워크 상황이 불안정하거나 서버 장애가 발생해도 시스템이 계속 작동할 수 있다. 또한 시스템 내부에서 발생한 데이터 변경 요청은 가능한 모든 노드에 반영되지만, 일관성은 보장 못한다.

- 장점 : 시스템이 언제나 가용하며, 장애 상황이 와도 시스템이 계속 작동이 가능하다. 네트워크 상황이 불안정해도 시스템이 작동 가능하다.
- 단점 : 데이터의 일관성이 보장되지 않으므로 일부 사용자는 다른 사용자와 다른 데이터를 볼 수 있다. 여러 노드 간의 데이터 동기화 시간이 필요하지 않으므로 빠른 응답 시간을 보장할 수 있지만, 데이터 일관성에는 손실이 발생 할 수 있다.
- 사례 : 주로 AP는 SNS, 채팅, 게임 등 빠른 응답이 필요한 서비스에 사용한다.

### AP 예시 
- DynamoDB는 NoSQL 데이터베이스로, 높은 가용성과 확장성을 제공하는데 CAP이론에서는 AP(가용성 우선)에 더 가깝게 설계되었다.
    - 가용성(Availability) : DynamoDB는 다중 AZ(Availability Zone) 복제를 통해 뛰어난 가용성을 제공한다.
    - 파티션(Partition) : 네트워크 파티션이나 서버 장애가 발생해도 데이터베이스 서비스가 계속 작동하도록 설계되어 있으며 데이터는 자동으로 여러 위치에 복제되어 어떤 부분의 시스템이 다운되더라도 전체 시스템의 작동에 영향을 주지 않는다. 
    - 일관성(Consistency) : 일관성 기능을 기본적으로 제공하지만, 필요에 따라 높은 수준의 일관성으로 수정할 수 있는 옵션을 제공한다.


## PACELC 이론

![Image](https://github.com/user-attachments/assets/7c31bb62-f64d-4d7b-8399-ac1e46a3fd84)

![Image](https://github.com/user-attachments/assets/66346473-9cc7-4cf0-92d3-fde19d515b75)

![Image](https://github.com/user-attachments/assets/9cc5be39-8033-4bf1-be19-66628cd6f892)


- PACELC 이론은 분산 시스템에서 데이터 일관성과 가용성 간의 상충 관계를 설명하는 이론이다. 이 이론에 따르면, 분산 시스템은 다음과 같은 상황에서 선택을 해야 한다.PACELC은 CAP이론에 네트워크 파티션이 발생하지 않는 경우와 발생하는 경우에 대해 추가 한 것이다.
- 기존 CAP는 Partiton 발생시 Availability와 Consistency 중 하나를 선택해야 했는데, PACELC의 경우 Else가 추가 되어 분할이 발생되지 않는 상황에서도 시스템은 Latency(지연 시간)과 Consistency(일관성) 사이에서 선택해야함을 의미한다.
    - 분할(Partition) 발생 시 : CAP 이론과 유사하게, 시스템은 가용성(A)과 일관성(C) 중 하나를 선택해야 한다
    - 분할이 없는 경우(Else) : 시스템은 일관성(C)을 유지하면서도 낮은 지연 시간(L)을 제공할 수 있다. 하지만 일관성을 강화하려고 하면 지연 시간이 증가할 수 있고, 반대로 지연 시간을 최소화하려고 하면 일관성 수준이 낮아질 수 있다.

- PACELC 이론은 이러한 상황에서, 분산 시스템이 어느 한 가지에 더 중점을 둬야 하는지를 선택하도록 안내한다. 예를 들어 P와 L에 더 중점을 둔다면, 시스템이 네트워크 분리 상황에서도 동작 가능하면서, 각 노드들 간의 통신 지연 시간을 최소화하는 방향으로 시스템을 설계할 수 있다.


### PACELC 속성
- P (Partition tolerance): 분산 시스템 내의 노드들이 서로 통신 불가능한 상황(네트워크 분리 등)이 발생할 경우, 그 상황을 감지하고 적절한 조치를 취하는 능력이다. 즉, 네트워크 분리 상황에서도 시스템은 동작해야 한다.
- A (Availability): 분산 시스템 내의 노드들 중 일부가 고장나거나 서비스를 중지시키는 상황이 발생해도, 전체 시스템은 계속해서 동작할 수 있는 능력이다. 즉, 언제나 서비스를 제공할 수 있어야 한다.
- C (Consistency): 분산 시스템 내의 노드들이 서로 다른 버전의 데이터를 가지고 있을 경우, 일관성 있는 데이터를 유지하는 능력이다. 즉, 모든 노드에서 같은 데이터를 보장해야 한다.
- E (Eventual consistency): 동시성이 보장되지 않는 데이터 변경 작업에 대해, 어느 정도 시간이 지나면 해당 변경 사항이 모든 노드에 반영된다는 것을 보장하는 능력입니다. 즉, 시간이 지나면 모든 노드가 같은 데이터를 가지게 된다.
- L (Latency): 분산 시스템의 각 노드들 간의 통신 지연 시간입니다. 즉, 모든 노드가 동일한 속도로 동작할 수 있어야 한다.
- C (Communication cost): 분산 시스템 내의 노드들 간의 통신 비용입니다. 즉, 최소한의 비용으로 통신이 이루어져야 한다.

### PACELC이론 예시 
- Apache Cassandra
    - 분할(Partition) 발생 시 : Cassandra는 Avaliability(가용성)을 우선시 한다. 그래서 파티션을 하더라도 읽기, 쓰기 작업을 계속 수행할 수 있는 AP(가용성 우선) 시스템으로 설계되어 있다. 쓰기 연산 또한 파티션 분할 중에도 여러 노드에 복제될 수 있고, 읽기 연산도 사용이 가능한 노드에서 수행한다.
    - 분할이 없는 경우(Else) : Cassandra는 Latency(지연시간)을 최소화하고 일관성을 튜닝할 수 있는 여러 옵션을 제공한다. 따라서 사용자는 읽기, 쓰기 작업에 대한 일관성 수준을 설정할 수 있다.

### 질문
#### PACELC 이론에 대해서 설명하세요
- CAP 이론은 네트워크 분할이 발생했을 때, 시스템이 일관성(Consistency)과 가용성(Availability) 중 하나를 선택해야 한다는 점을 설명합니다. 그런데 실제 환경에서는 네트워크가 정상일 때도 시스템 설계에서 중요한 고려사항이 있다는 점에서, 이를 보완한 이론이 PACELC 이론입니다.
- PACELC는 '만약 P(Partition)이 발생하면 A(Availability) 또는 C(Consistency) 중 선택해야 하고, Else(네트워크가 정상이라면) L(Latency) 또는 C(Consistency) 중 선택해야 한다'는 의미입니다.
- 즉, PACELC는 네트워크 장애 상황뿐 아니라 정상 상황에서도 일관성과 지연 시간 간의 트레이드오프를 함께 고려한다는 점에서 CAP보다 더 현실적인 분산 시스템 이론이라고 볼 수 있습니다.

----
참고링크 

https://velog.io/@hwan2da/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-CAP-%EC%9D%B4%EB%A1%A0

https://etloveguitar.tistory.com/159

https://onduway.tistory.com/106

https://sabarada.tistory.com/91

https://velog.io/@dodozee/CAP-%EC%9D%B4%EB%A1%A0%EC%9D%B4%EB%9E%80-PACELC-%EC%9D%B4%EB%A1%A0%EC%9D%B4%EB%9E%80-feat.-%EB%B8%94%EB%A1%9D%EC%B2%B4%EC%9D%B8

https://kejdev.github.io/db/2024/02/10/CAP-PACELC.html