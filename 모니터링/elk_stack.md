## ELK stack

![Image](https://github.com/user-attachments/assets/f9a88154-5295-45fb-bf32-e19b0d644b49)

- ELK 스택은 Elasticsearch, LogStash, Kibana의 로그 수집 및 시각화를 위한 세가지 오픈소스 프로젝트를 의미한다.
- ELK 스택은 원래 독립적으로 개발되던 오픈소스 프로젝트였지만 각각의 구성 요소가 개별적으로 갖는 강점을 결합하여 효과적인 데이터 분석 및 모니터링 솔루션으로 사용한다. 보통 메인은 Elasticsearch으로 Elasticsearch를 사용하고자 할 때, 다양한 소스에서 데이터를 편하게 수집하기 위해 LogStash를 함께 사용하고, 저장된 데이터를 편하게 시각화하고 분석하기 위해 Kibana를 함께 사용한다. 3가지 프로젝트를 항상 함께 사용할 필요는 없다. 그러나 ELK 스택은 Elastic이라는 회사에서 함께 개발하고 세가지 프로젝트를 같이 사용하기에 편리하게끔 최적화 시켜놨기 때문에 다른 특별한 이유가 없다면 함께 사용하는게 좋다.
- ELK 스택은 독립된 모듈로 사용할 수도 있고, 다른 오픈소스 프로젝트와 연동해도 무방하다. Beats라는 경량화된 데이터 수집 모듈과 함께 사용할 수도 있다. 또한 데이터를 안정적으로 버퍼링하고 전달하는 Redis, Kafka, RabbitMQ 등과 같이 사용할 수도 있다.

## ELK 용도
### 전문 (full text) 검색 엔진
- 전문 full text : 단순한 문장부터 뉴스 기사나 논문 등 다양한 글의 전체 내용을 의미
- 엘라스틱 서치의 기본적인 용도는 전문 검색 엔진의 구현이다. 일반 RDB에 비해 엘라스틱서치의 검색 성능이 좋은 이유는 전문 검색을 빠르고 정확하게 하기 위해 용어 term 단위로 분석해 인덱싱을해두고 이를 기반으로 검색을 수행하는 역인덱싱 inverted indexing 기법이 활용되었기 때문이다. 엘라스틱 스택에는 용어 분석을 위한 다양한 언어별 분석기가 있고, 유사도 스코어링을 위해 다양한 방법을 제공한다.

### 로그 통합 분석
- 엘라스틱서치는 로여러 장비와 서비스에서 발생하는 로그들을 통합하고 검색하는 데 최적화된 솔루션이다. 로그를 별도의 복잡한 구성없이 바로 수집할 수 있다. 비츠를 이용해 적은 리소스로 로그들을 수집하고, 로그스태시로 다양한 필터를 통해 일원화된 형태로 가공하고, 엘라스틱서치로 대용량 로그를 빠른 인덱싱과 텍스트 검색을 통헤 로그들을 통합해 연관 분석을 지원할 수 있다. 또 키바나로 로그 UI나 대시보드를 사용해 모니터링을 할 수 있다.

### 보안 이벤트 분석
- 엘라스틱 SIEM(Security Information and Ebent Mangament)은 비츠의 모듈을 이용해 애플리케이션, 엔드포인트, 인프라스트럭처, 클라우드, 네트워크 등 다양한 소스에서 수집한 이벤드를 기반으로 엔드포인트 활동, 인증 로그, DNS 트래픽, 네트워크 플로우에서 이상 징후, 불법 로그인 시도, 사용자 접근 패턴 등의 문제를 빠르게 찾아낸다. 또한, SIEM UI에서 분석을 비롯한 고유한 탐지 규칙 또한 가능하다.

### 애플리케이션 성능 분석
- 엘라스틱 스택의 성능 모니터링 도구 APM, Application Performance Monitoring 은 프로그래밍 언어별 에이전트를 통해 성능 지표 수집을 돕고 분석을 위한 UI를 제공한다. 또한, 메트릭 비츠와 패킷 비츠를 사용해 시스템을 비롯해 연계된 다양한 서비스들의 성능 정보를 수집할 수 있게 도와준다. 이 기능은 다른 UI나 머신러닝 등의 기능과 연계하면 효과가 배가 된다.

### 머신러닝
- 엘라스틱 유료 라이선스를 구매할 경우 머신러닝 기능을 제공한다. 데이터를 엘라스틱 서치에 저장한 후 비지도 학습을 통해 데이터에서 패턴을 발견할 수 있고, 시계열 모델을 통해 이상 징후를 탐지하고 과거 데이터를 기반으로 동향을 예측하게 도와준다.

### 빅데이터 플랫폼
- 엘라스틱스택은 하둡, 카프카, RDB등과 연동하여 빅데이터 파이프라인의 일부로 동작할 수 있다.

## 데이터 저장 방법 (RDBMS와 차이점)
- RDB는 정규화된 스키마에 따라 데이터를 구조화하지만, Elasticsearch는 JSON 문서 형태로 비정형 데이터도 저장하고 인덱싱할 수 있다.
- RDB는 Row를 기반으로 데이터를 저장하지만, Elasticsearch는 단어를 기반으로 데이터를 저장한다.
- Elasticsearch은 마치 NoSQL의 key-value DB와 같이 저장된다. 그렇기 때문에 Elasticsearch는 수정과 삭제가 많은 경우에는 많은 리소스가 소비될 수 있지만 검색 속도는 빠르다는 장점이 있다.


## Elasticsearch
- Elasticsearch는 실시간 분산형 검색엔진이다. 주로 데이터 검색 및 분석을 위해 사용되고 데규모 데이터를 저장하고 실시간으로 검색할 수 있도록 설계되었다. Java 기반으로 제작되었고, 스키마가 없는 NoSQL 데이터베이스 계열에 속한다.

### Elasticsearch 특징
### 병렬 처리, 분산 처리
- 엘라스틱 서치는 텍스트나 도큐먼트의 경우 인덱싱 시점에 분석을 거쳐 용어 단위로 분해하고 역인덱스 사전을 구축한다. 숫자나 키워드 타입의 데이터들은 집계에 최적화된 칼럼 기바 자료구조를 저장한다. 최적화된 자료구조를 바탕으로 병쳘처리나 분산처리를 할 수 있다. 클러스처가 구성되어 있다면 데이터 양과 무관하게 1초 이내의 응답을 기대할 수 있다.
- 분산 시스템으로서 엘라스틱 서치는 복수의 인스턴스를 병렬로 배치하고 분선 처리해 검색 속도를 무한히 확장할 수 있게 한다. 또한, 노드 간 복제 기능을 통해 일부 노드가 다운되더라도 정상적으로 서비스를 지속할 수 있게 한다.

### Lucene 기반 검색 엔진 (최적화된 자료구조 지원, 스코어링 scoring 등..)
- 엘라스틱 서치는 루씬 기반 검색엔진으로 검색 엔진으로서 강력한 기능들을 가지고 있다. 그 중 하나가 스코어링 scoring, 연관도에 따른 정렬이다. 검색어에 대해 유사도 스코어를 기반으로 한 정렬을 제공한다. 이것은 문자열 콘텐츠에서 검색을 수행할때 강력한 기능이 된다.

### REST API
- 엘라스틱서치의 편리한 점은 모든 통신을 REST API를 이용하도록 만들어 프로그래밍 언어와 무관하게 활용할 수 있다. 별도의 드라이버 라이브러리가 없더라도 웹 브라우저나 curl 명령 등을 이용해 기능을 활용할 수 있다.

### DSL (Domain Specific Language)
- 엘라스틱서치는 DSL 쿼리를 사용하는데 JOIN 쿼리가 어렵기 때문에 반정규화를 기본으로 모델링해야 한다.

### Elasticsearch 장점
- 사용 편의성 : RESTful API를 제공하여 쉽게 데이터를 쿼리하고 관리할 수 있다. 진입 장벽이 낮다.
- 확장성 : Elasticsearch는 scale-out이 가능하다. 클러스터에 노드를 추가함으로써 트래픽이 증가해도 성능을 유지할 수 있다.
- 생태계 : 오픈소스이기 때문에 활발한 커뮤니티와 다양한 플러그인, 도구가 제공된다.
- Schema less : Json 문서를 통해 데이터 검색을 수행하므로 스키마 개념이 없다. 로그 데이터 처럼 비구조화된 데이터는 스키마가 다이나믹하게 변할 수 있기 때문에 JSON 구조가 적합하다.
- 분산 시스템으로 설계되어 대량의 데이터도 유연하게 저장가능
    - RDB는 트랜잭션 처리와 데이터 일관성 유지에 중점을 두고 설계 되었기 때문에 무수히 생성되는 로그 데이터를 실시간으로 저장하는 것은 한계가 있을 수 있다. 대부분의 RDBMS는 단일 노드에서 실행지만 Elasticsearch는 처음부터 분산 시스템으로 설계되었다. 그렇기 때문에 데이터를 여러 노드에 분산 저장하고 처리 및 새로운 노드를 추가(수평 확장(Scale out))할 수 있고, 스키마리스(schema-less) 방식이므로, 비구조화된 대량 데이터도 유연하게 저장할 수 있다.
- 검색에 최적화된 엔진(Lucene 기반)을 사용해 대용량 데이터에서도 빠르게 검색 가능
    - 로그 데이터는 구조화되어 있지 않고 비구조화된 텍스트로 이뤄져있다. 비구조화된 많은 로그 데이터들을 RDB에서 조회하려면 복잡한 텍스트를 검색하기 힘들뿐더러, 인덱싱과 같은 추가 작업이 요구되어 시스템 부하가 증가할 수 있다. 반면에 Elasticsearch는 전체 텍스트 검색에 최적화된 엔진(Lucene 기반)을 사용해 대용량 데이터에서도 빠르게 정보를 찾을 수 있다. 또한 모든 데이터를 역 색인 구조로 저장해 가공된 텍스트를 검색한다.거의 실시간 검색으로 사용할 수 있기 때문에 보안 분석, 인프라 모니터링 같은 사용 사례에 적합하다.
    - 역인덱싱이란? 
        - 역색인은 특정 단어를 포함한 문서들을 저장해둬서 특정 단어를 찾을 때 저장된 문서 목록을 확인한다.역색인 구조로 특정 단어를 찾을 때 문서 전체가 아닌 단어를 포함한 특정 문서의 위치를 찾기 때문에 빠르다.예를들어서 "This is Dev Blog"라는 문장이 있다면 Elasticsearch는 "The", "is", "Dev", "Blog" 각각의 단어에 대해 해당 단어가 속한 문서의 ID를 인덱스에 저장한다.따라서 사용자가 "Blog"라는 단어를 검색 요청하면 Elasticsearch는 "Blog"의 역인덱스 목록에서 겹치는 문서 ID를 찾아내고 해당 문서를 검색 결과로 반환하다.
- 데이터 구조 유연성
    - RDB에서는 스키마 변경이 필요한 경우에는 DDL 작업이 필요하며 이 작업은 리소스 소모가 크고 복잡하다. 반면에 Elasticsearch는 JSON 형식의 문서 기반 모델을 사용해 스키마 변경 없이도 다양한 형태의 데이터를 유연하게 저장할 수 있다.
- 가용성
    - 자동 복제(replication)와 샤딩(sharding) 기능으로 인해, 하나 또는 여러 개의 노드가 실패해도 서비스 중단 없이 데이터 저장 및 검색 작업을 계속 할 수 있다.
 

### Elasticsearch 단점
- 메모리 사용 : Elasticsearch는 많은 메모리를 사용하므로, 메모리 제약이 있는 환경에서 조심해야 한다.
- 복잡성 : 초기설정이 복잡하다. 클러스터링, 보안 설정등을 구성하는데 어려울 수 있다.
- 빠르지만 완전히 실시간은 아니다. Elasticsearch는 데이터 저장 시점에 해당 데이터를 인덱싱한다.
- 트랜잭션과 롤백기능이 없다.
    - 전체적인 클러스터의 성능 향상을 위해서 시스템적으로 비용 소모가 큰 롤백과 트랜잭션을 지원하지 않는다. 즉, 트랜잭션과 무결성이 중요한 데이터의 저장소로 사용하기에 적합하지 않다. Elasticsearch가 DB의 기능도 하지만 메인 데이터베이스로 단독 사용하는 것은 권장되지 않는다. 엄격한 데이터 요구사항이 있는경우에는 RDB가 더 적합하다.
- 데이터 삭제 및 수정의 비효율성
    - Elasticsearch는 실시간 검색과 분석을 위해 설계되었다. 그렇기 때문에 데이터 삭제나 수정 작업은 상대적으로 비효율적이다. (Elasticsearch 에서의 업데이트는 기존 문서를 삭제하고 다시 삽입하는 방식)


## LogStash
- LogStash는 다양한 소스에서 데이터를 수집하고, 변환하며, ElasticSearch 또는 다른 저장소에 전달하는 데이터 처리 파이프 라인 도구이다. 로그파일, 이벤트로그, 메트릭 등 다양한 소스에서 데이터를 수집할 수 있고, 데이터를 필터링 및 정규화하여 Elasticsearch에 인덱싱 할 수 있다.

### LogStash 특징
### 데이터 수집 및 가공
- 로그스태시를 사용해 로그, 메트릭, 웹 어플리케이션 등 다양한 소스로부터 로그를 수집할 수 있다. 또한, 필터 기능을 사용해 비정형이나 반정형 데이터를 분석하기 쉬운 형태로 정제할 수 있고, 엘라스틱서치 외에 다양한 플랫폼으로 정제된 데이터를 내보낼 수 있다.

### 로그스태시 동작
- 형식에 무관하게 데이터를 동적으로 수집, 변환, 전송하는 구조로 되어있다. 비구조적인 데이터에서도 구조를 도출하고, IP주소에서 위치 정보 좌표를 해독하고, 민감한 필드를 익명화하거나 제외시키는 등의 전반적인 작업을 쉽게 해준다.

### 로그 가공
- 코딩 없이 간단한 설정만으로도 로그를 가공할 수 있다. 설정의 대부분을 플러그인으로 사용할 수 있는데 200개 이상의 플러그 인이 존재한다.

### 엘라스틱서치 인덱싱 성능 최적화
- 로그스태시를 사용해 엘라스틱서치의 인덱싱 성능을 최적화하기 위한 배치 처리와 병렬 처리가 가능하고, 영속적인 큐를 사용해 현재 처리 중인 데이터양이 급증하는 부하 상황에서도 안정성을 보장해준다.

## Kibana
- Kibana는 Elasticsearch에서 저장된 데이터를 시각화하고 분석하는 데 사용된다. 사용자는 대시보드, 차트, 그래프 및 지도를 생성하여 데이터를 탐색하고 시각적으로 표현할 수 있다. Elasticsearch와 연동하여 거의 실시간으로 데이터를 시각화 할 수 있다는 큰 장점이 있다.

### Kibana 특징

### 엘라스틱서치의 UI
- 엘라스틱서치는 모든 입력을 REST API형태로 받아들이기 때문에 복잡한 요청을 일일히 작성하기에 불편함이 있을 수 있다. 이런 불편을 해소해주는 것이 키바나이다. 키바나에는 엘라스틱서치에 대한 대부분의 관리 기능, API를 실행할 수 있는 콘솔, 솔루션 페이지, 스택의 각 구성요소들을 위한 모니터링 페이지 등이 포함되어있다.

### 시각화, 대시보드
- 키바나는 시각화와 대시보드 기능을 제공해준다. 라인 차트, 파이 차트 등과 테이블, 지도 등의 다양한 시각화 요소들을 클릭 몇 번으로 쉽게 구성할 수 있다. 특히 대시보드 기능으로 시각화 요소들을 한 화면에 배치하고 실시간 업데이트할 수 있다.

### 실시간 모니터링, 데이터분석, APM, SIEM 등의 솔루션
- 프레젠테이션 만들듯이 시각화를 구성할 수 있는 캔버스, 실시간으로 인덱싱되는 로그를 지속적으로 확인할 수 있는 로그, 애플리케이션의 성능 모니터링을 위한 APM, 보안 이벤트를 관제할 수 있는 SIEM 등 강력한 솔루션이 포함되어 있다.

## Beats
- ELK스택이 더욱 널리 사용될 수 있었던 큰 요인중 하나가 Beats의 연동이다. 기존 LogStash는 데이터 수집과 데이터 입출력 및 필터 그리고 변환까지 담당하고 있었기에 오버헤드가 굉장히 크다. 그러나 데이터 수집만을 담당하는 Beats를 도입함으로써 애플리케이션의 성능에 영향을 미치지 않고 필요한 이벤트를 수집할 수 있다.
- 엘라스틱서치에서는 공식적으로 파일비트, 메트릭비트, 패킷비트, 윈로그비트, 오딧비트, 하트비트, 펑션비트, 카프카비트 등 상당히 많은 비트를 지원한다. 또한 온프레미스와 가상 머신뿐만 아니라 컨테이너와 쿠버네티스 환경에서도 사용이 가능하다.

### Beats 특징
### 용도별로 최적화된 경량 에이전트
- 로그스태시로 이벤트 정보를 수집하기 위해선 실제 서비스 호스트에 수집기를 설치해야하는데 로그스태시는 다양한 필터와 설정을 제공해 무겁기 때문에 활용도가 떨어질 수 있다. 따라서 파일비츠, 메트릭비츠 라고 부르는 경량수집기인 비츠가 포함되어 있다. 복잡한 이벤트 가공은 지원하지 않고 가벼워서 서비스 호스트에 부담없이 설치할 수 있다.
- Golang으로 작성됨

### Beats의 종류와 구조
![Image](https://github.com/user-attachments/assets/709fbc5a-ccf5-4a43-b1c7-c0b06b94cffe)

- 보통 비츠에서 서비스 호스트 정보를 수집하고 로그스태시에서 취합, 가공해 엘라스틱 서치로 전송하는 아키텍처가 많이 사용된다.
- 특히, 파일비츠의 내장된 모듈에 서비스 정제를 위한 파이프라인 설정, 샘플 대시보드 등의 기능이 포함되어 별도의 설정 없이 빠르게 로그 수집 가능하다. 또한, 비츠의 모듈을 사용할 경우 엘라스틱에서 제공하는 ECS(Elastic Common Schema)구조에 맞춰 로그를 인덱싱한다. 이 기능은 다른 서비스들을 같은 스키마에 매핑함으로써 연관 분석을 용이하게 한다. 필드명이 다를경우 각 로그에 맞게 쿼리를 작성해야하지만 표준 스키마에 맞춘다면 하나의 쿼리로 검색이 가능해진다.


## 데이터 흐름
- 1. 1개 이상의 수집할 Data 발생 서버에서 beats가 특정 트리거에 의해 logstash로 Data를 전송한다. 여기서 각 Client서버 마다 Beats가 설치되어 있어야한다.
- 2. logstash로 전달 된 Data를 커스터마이징이 가능한 필터를 통해 가공하여 Elasticsearch로 전달한다.
- 3. Elasticsearch로 전달 받은 데이터를 서버(Elasticsearch)에 저장한다.
- 4. kibana에서 연동되있는 Elasticsearch에 저장된 데이터 셋을 토대로 시각화를 제공한다.


---


참고링크 

https://idkim97.github.io/2024-04-22-ELK(Elasticsearch+LogStash+Kibana)%20%EC%8A%A4%ED%83%9D%EC%9D%B4%EB%9E%80/

https://newtoner.tistory.com/78

https://hstory0208.tistory.com/entry/ELK-ElasticSearch%EB%9E%80-ELK%EB%9E%80-%EC%9E%A5%EB%8B%A8%EC%A0%90-RDB%EC%99%80-%EC%B0%A8%EC%9D%B4

https://hstory0208.tistory.com/entry/ELK-ElasticSearch%EB%9E%80-ELK%EB%9E%80-%EC%9E%A5%EB%8B%A8%EC%A0%90-RDB%EC%99%80-%EC%B0%A8%EC%9D%B4