# Stream 지연연산
- 스트림의 대표적인 특징 중 하나는 바로 지연 연산(Lazy Evaluation)1을 수행한다는 데에 있다.
- Lazy vs Eager 지연 연산이란 간단히 말해 결과값이 필요할 때까지 계산을 늦추는 기법이다.
- 즉, 눈앞에 코드가 주어졌을 때 곧바로 해당 코드를 실행하는 것이 아니라 실행 결과가 필요해지는 시점에 실행하도록 하는 것이다. 
- 다만, 이러한 방식으로 코드가 동작하기 위해 내부적으로 준비해주는 작업이 필요하므로 무조건 효율적인 방식이라고는 보기 어렵다. 이에 반해 어떠한 작업이 즉시(eager) 수행된다면 말 그대로 실행할 코드가 보이는 순간 곧바로 실행된다는 의미이다. 
- 사실 특정 작업의 실행 결과가 향후 필요하다는 점이 확실하다면 미리 실행해놓는 것이 기본적으로 성능 측면에서 우월하다고 볼 수 있다. 
- 지연 연산과 최적화 스트림 파이프라인을 실행하게 되면 JVM은 곧바로 스트림 연산을 실행시키지 않는다. 그 대신 최소한의 필수적인 작업만을 수행하고자, 즉 지연 연산을 위한 준비작업을 수행한다.
- 이 준비 작업이란 우선 스트림 파이프라인이 어떠한 중간연산과 최종연산으로 구성되어있는지에 대한 검사로 시작된다. 이러한 검사 결과를 바탕으로 JVM은 사전에 어떠한 방식으로 최적화를 진행할지 미리 계획하고, 그 계획에 따라 스트림의 개별 요소에 대한 스트림 연산을 수행하게 된다. 그리고 스트림에서 제공하는 최적화 전략으로는 루프퓨전과 쇼트서킷이 대표적이다.

#### 루프퓨전 
- 루프퓨전(loop fusion)이란 파이프라인에서 연속적으로 체이닝된 복수의 스트림 연산을 하나의 연산 과정으로 병합시키는 것을 뜻한다.

#### 쇼트서킷
- 쇼트서킷(short circuit)이란 기본적으로 불필요한 연산을 의도적으로 수행하지 않음으로써 실행 속도를 높이는 기법을 의미한다.3 그리고 스트림에서의 쇼트서킷은 limit과 같은 연산을 활용하여 스트림의 일부 요소들에 대한 연산을 완전히 생략하는 것을 의미한다.


## map()과 flatMap()

### map()
- map()은 단일 스트림의 원소를 매핑시킨 후 매핑시킨 값을 다시 스트림으로 변환하는 중간 연산을 담당한다. 객체에서 원하는 원소를 추출해는 역할을 한다고 말할 수 있다. 
- map()은 스트림에 접근해서 사용자가 원하는 매핑을 실행해주는 메서드이다. "리스트 안에 있는 각각의 항목을 변환해서 다른 값으로 바꾼다."
- 변환만 하고 모양(구조)는 유지한다. 한개씩 작업할 때 사용ㅎ암
- 필터가 조건을 충족시키는 새로운 스트림을 생성한다면, Map은 각각의 아이템을 변경하여 새로운 컨텐츠를 생성하는 기능이다.
- 데이터 하나를 다른 하나로 변환 시킨다 하나가 들어오면 하나 나가는 방식. 1:1 변환

```
        List<Integer> list = Arrays.asList(2, 3, 5, 7);

        List<Integer> result = list.stream()
                .map(a -> a * 2) // 모든 요소에 곱하기 2
                .collect(Collectors.toList());

        System.out.println(result);
        // 결과 : [4, 6, 10, 14]
```


### flatMap()
![image](https://github.com/user-attachments/assets/46297e51-93a2-4fcc-b46f-77a927244b39)
- flatMap()은 Array나 Object로 감싸져 있는 모든 원소를 단일 원소 스트림으로 반환.
- 데이터하나를 여러개로 나누거나 여러 데이터를 하나로 합친다. 여러개 들어가고 평평한 하나로 나오는 구조(flat)이라고 생각하면 됨.
- 여러개 나눠진것을 평평하게 합친다 -> 묶여있는 걸 풀어서 작업할떄 사용.
- map()은 입력한 원소를 그대로 스트림으로 반환하지만 .flatMap()은 입력한 원소를 가장 작은 단위의 단일 스트림으로 반환
- 단도직입적으로 말하면, flatMap()은 다중 스트림을 평탄화하는 역할을 한다. 즉, 다중 스트림을 하나의 스트림으로 합친다는 뜻이다.
- flatMap() 은 여러개의 스트림을 한개의 스트림으로 합쳐준다. 복잡한 스트림을 간단한 스트림으로 변경되는데 사용할 수 있다. 예를들어 아래 코드에서는 Stream<String[]>를 Stream<String> 형태로 변환했다.

```
    
        List<String> list = Arrays.asList("Gni", "Dinger");

        List<String> result2 = list.stream()
                .flatMap(a -> Arrays.stream(a.split("")))
                .collect(Collectors.toList());

        System.out.println(result2);
        // 결과 [G, n, i, D, i, n, g, e, r]
```
```
String[][] arrays = new String[][]{ {"a1", "a2"}, {"b1", "b2"}, {"c1", "c2", "c3"} };
Stream<String[]> stream = Arrays.stream(arrays);
Stream<String> stream2 = stream.flatMap(s -> Arrays.stream(s));
stream2.forEach(System.out::println);

// 결과 
a1
a2
b1
b2
c1
c2
c3
```

### 질문
####  Lazy Evaluation이 Java Stream에서 성능 최적화에 어떤 방식으로 기여할 수 있는가?
- Lazy Evaluation은 중간 연산의 실행을 지연시키고 최종 연산이 호출될 때만 연산을 수행합니다. 이를 통해 연산에 필요한 데이터만 처리하며, 루프퓨전(loop fusion)을 통해 연속된 연산을 병합하고 쇼트서킷(short circuit)을 활용하여 불필요한 연산을 생략함으로써 성능을 최적화합니다.

#### map()과 flatMap()의 주요 차이점은 무엇이며, flatMap()이 필요한 상황은 어떤 경우인가?
- map()은 1:1 매핑으로 각 데이터를 변환하지만, 원소의 구조를 유지합니다. 반면, flatMap()은 다중 스트림을 하나의 단일 스트림으로 평탄화(flatten)하며, 복잡한 데이터 구조를 단순화하는 데 사용됩니다. 예를 들어, 배열이나 중첩된 컬렉션을 단일 스트림으로 변환해야 할 때 flatMap()을 사용합니다.

--- 

참고링크 

https://bugoverdose.github.io/development/stream-lazy-evaluation/

https://unagi-zoso.tistory.com/283