## DB Connection
- DB를 사용하기 위해 DB와 애플리케이션 간 통신을 할 수 있는 수단. DB Connection은 Database Driver와 Database 연결 정보를 담은 URL이 필요함
- Java의 DB Connection은 JDBC를 주로 이용하는데, URL 타입을 사용함
- DB와의 연결(Connection)은 비용이 크기 때문에, 이를 미리 만들어 두고 재사용하는 방식. 애플리케이션이 DB와 통신할 때 새로운 커넥션을 매번 생성하면 비효율적이므로, Connection Pool을 활용해 재사용 가능한 커넥션을 관리한다. 대표적인 구현체: HikariCP, C3P0, Apache DBCP 등

## JDBC
- Jaba Database Connectivity의 약어로 자바 언어로 다양한 종류의 관계형 데이터베이스에 접속하고 SQL문을 수행하여 처리하고자 할 때 사용되는 표준 SQl 인터페이스 API이다. 원래라면 DB마다 연결 방식과 통신 규격이 따로 있기 때문에 프로그램을 DB와 연결한다면, 해당 DB와 관련된 기술적 내용을 배우고 DB가 변경될 시 많은 변경 사항이 존재한다. 하지만 각 DBMS에 맞는 JDBC를 받아주게 되면 쉽게 DBMS를 변경할 수 있게 된다. 즉, DBMS 종류(MySQL, MsSQL, Oracle 등)에 상관 없이 하나의 JDBC API를 사용해서 데이터베이스 작업을 처리할 수 있게 된다. 
- 자바 애플리케이션에서 데이터베이스에 접근하기 위해서는 JDBC API를 이용해서 데이터베이스에 접근하고, JDBC API는 JDBC 드라이버를 거쳐 데이터베이스와 통신을 한다.

## Connection Pool
![Image](https://github.com/user-attachments/assets/448e5bf7-50fb-4ae9-9c41-b2b2a87f734a)

- 자바에서 DB에 직접 연결해서 처리하는 경우 JDBC Driver를 로드하고 커넥션 객체를 받아와야 한다. 그러면 매번 사용자가 요청을 할 때마다 드라이버를 로드하고 커넥션 객체를 생성하여 연결하고 종료하기 때문에 매우 비효율적이다. 이런 문제를 해결하기 위해서 커넥션 풀을 사용한다.
- 웹 컨테이너(WAS)가 실행되면서 일정량의 Connection 객체를 미리 만들어서 pool에 저장했다가, 클라이언트 요청이 오면 Connection 객체를 빌려주고 해당 객체의 임무가 완료되면 다시 Connection 객체를 반납 받아서 pool에 저장하는 프로그래밍 기법이다.
- Container 구동 시 일정 수의 Connection 객체를 생성하게 되며 클라이언트의 요청에 의해 애플리케이션이 DBMS 작업을 수행해야 하면, Connection Pool에서 Connection 객체를 받아와 작업을 진행한다. 이후 작업이 끝나면 Connetion Pool에 Connection 객체를 반납한다.

## 커넥션 풀(DBCP)의 동작 원리
### Hikari CP가 동작하는 방식
![Image](https://github.com/user-attachments/assets/b64aaf1e-39c5-45f6-8248-5508523557a5)
- Thread가 Connection을 요청하면 Connection Pool의 각자의 방식에 따라 유휴 Connection을 찾아서 반환한다. Hikari CP의 경우, 이전에 사용했던 Connection이 존재하는지 확인하고, 이를 우선적으로 반환하는 특징이 있다.

![Image](https://github.com/user-attachments/assets/2ec83374-e0dd-4e30-b070-2678be0ec861)
- 가능한 Connection이 존재하지 않으면, HandOffQueue를 Polling하면서 다른 Thread가 Connection을 반납하기를 기다린다. (지정한 TimeOut 시간까지 대기하다가 시간이 만료되면 예외를 던진다.)

![Image](https://github.com/user-attachments/assets/b60e79b0-60a3-4a48-ae8f-d3429977bdbd)
- 최종적으로 사용한 Connection을 반납하면 Connection Pool이 Connection 사용 내역을 기록하고, HandOffQueue에 반납된 Connection을 삽입한다. 이를 통해 HandOffQueue를 Polling하던 Thread는 Connection을 획득하고 작업을 이어나간다.

## ThreadPool
- 애플리케이션에서 일정 개수의 스레드를 미리 생성해 두고 필요할 때 가져다 쓰는 방식. 스레드 생성/소멸 비용을 줄이고, 동시 요청을 효과적으로 처리할 수 있다. 주로 웹 서버(예: Tomcat의 ExecutorService)에서 요청을 처리하는 데 사용된다. 쓰레드 풀은 미리 일정 개수의 쓰레드를 생성하여 관리하는 기법. 이렇게 생성된 쓰레드들은 작업을 할당받기 위해 대기 상태에 있게 되는데, 작업이 발생하면 대기 중인 쓰레드 중 하나를 선택하여 작업을 수행한다. 작업이 완료되면 해당 스레드는 다시 대기 상태로 돌아가고, 새로운 작업을 할당받을 준비를 한다.
- 쓰레드 풀을 사용하면 스레드 생성 및 삭제에 따른 오버헤드를 줄일 수 있으며, 특정 시점에 동시에 처리할 수 있는 작업의 개수를 제한할 수 있다. 이를 통해 시스템의 자원을 효율적으로 관리하고 성능을 향상시킬 수 있다.


### 커넥션 풀(DBCP)의 장점
- DB 접속 설정 객체를 미리 만들어 연결하여 메모리 상에 등록해 놓기 때문에 불필요한 작업(커넥션 생성, 삭제)이 사라지므로 클라이언트가 빠르게 DB에 접속이 가능하다.
- DB Connection 수를 제한할 수 있어서 과도한 접속으로 인한 서버 자원 고갈 방지가 가능하다.
- DB 접속 모듈을 공통화하여 DB 서버의 환경이 바뀔 경우 쉬운 유지 보수가 가능하다.
- 연결이 끝난 Connection을 재사용함으로써 새로 객체를 만드는 비용을 줄일 수 있다.

## 스레드 풀과 DB 커넥션 풀의 중요성
- 소프트웨어 개발에서 성능 최적화는 중요한 과제 중 하나입니다. 특히, 멀티스레드 환경에서 스레드 풀과 데이터베이스(DB) 커넥션 풀은 애플리케이션의 성능과 직결되는 핵심 요소. 스레드 풀은 작업 처리를 위해 스레드를 효율적으로 관리하는 방법이며, DB 커넥션 풀은 데이터베이스 연결을 재사용함으로써 연결 생성과 소멸에 드는 비용을 줄이는 기술. 이 두 풀을 적절히 관리하지 않으면, 애플리케이션의 성능 저하는 물론, 다양한 문제가 발생할 수 있다. 왜냐하면 스레드 풀과 DB 커넥션 풀의 크기 및 관리 방법이 애플리케이션의 성능에 직접적인 영향을 미치기 때문이다.
### Thread Pool과 DB Connection Pool의 관계 :: 웹 요청 처리 흐름
- 클라이언트 요청이 오면 Thread Pool에서 스레드 하나를 할당.
- 해당 스레드는 비즈니스 로직을 수행하며 DB에 접근해야 하는 경우 DB Connection Pool에서 커넥션을 가져옴.
- DB에서 데이터를 조회하거나 변경한 후, 커넥션을 반환하고 응답을 반환.
- 스레드는 다시 Thread Pool로 돌아가 대기 상태가 됨.

### 스레드 풀과 DB 커넥션 풀의 상관관계
- 스레드 풀과 DB 커넥션 풀 사이에는 밀접한 상관관계가 있다. 스레드 풀의 크기가 DB 커넥션 풀의 크기보다 크면, 동시에 많은 스레드가 DB 커넥션을 요구하게 되지만 사용 가능한 커넥션이 제한되어 있기 때문에 병목 현상이 발생할 수 있다.
- 반대로, DB 커넥션 풀의 크기가 스레드 풀의 크기보다 크면, 많은 DB 커넥션이 유휴 상태로 남게 되어 자원이 낭비될 수 있다. 왜냐하면 동시에 처리할 수 있는 스레드의 수가 제한되어 있기 때문이다.
따라서, 스레드 풀과 DB 커넥션 풀의 크기를 적절히 조절하는 것이 중요하다. 이를 통해 자원의 효율적인 사용과 애플리케이션의 성능 최적화를 달성할 수 있다. 스레드 풀과 DB 커넥션 풀의 상관관계를 이해하고, 이에 따른 최적화 전략을 수립하는 것은 애플리케이션의 성능을 결정짓는 중요한 요소이다.

### 두 개의 풀 크기가 적절하지 않으면 생기는 문제
-  Thread Pool이 너무 크고, DB Connection Pool이 작을 경우
    - 동시에 많은 요청을 처리하기 위해 스레드는 많이 생성되었지만, 사용 가능한 DB 커넥션이 부족해지는 문제 발생.
    - 결과적으로 스레드들이 DB 커넥션을 기다리면서 **응답 지연(latency 증가)**이 발생.
    - 최악의 경우, DB Connection Pool의 대기 시간이 초과되면 TimeoutException 발생.

### DB Connection Pool이 너무 크고, Thread Pool이 작을 경우
    - 사용 가능한 DB 커넥션은 충분하지만, 웹 요청을 처리할 스레드가 부족한 상황.
    - 요청이 밀려서 대기 시간이 길어지고, 전체 응답 속도가 저하됨.
    - CPU가 충분히 활용되지 못하고, 애플리케이션 성능이 저하됨.

### Thread Pool과 DB Connection Pool의 크기가 모두 너무 큰 경우
    - 지나치게 많은 스레드와 커넥션을 관리하는 데 오버헤드(컨텍스트 스위칭 비용, 메모리 사용 증가) 발생.
    - 오히려 전체 성능이 저하될 수 있음.

## 스레드 풀 최적화 전략
- 스레드 풀의 최적화는 애플리케이션의 성능에 직접적인 영향을 미친다. 스레드 풀의 크기를 너무 작게 설정하면 스레드가 부족해 작업 처리가 지연될 수 있으며, 너무 크게 설정하면 자원 낭비와 컨텍스트 스위칭 비용이 증가할 수 있다. 스레드 풀의 최적화를 위해서는 애플리케이션의 작업 특성을 분석하고, 스레드 풀의 사용 패턴을 모니터링하는 것이 필요하다. 이를 통해 스레드 풀의 크기를 동적으로 조절하거나, 스레드 풀의 구성을 최적화할 수 있다.
- 스레드 풀의 최적화는 애플리케이션의 성능을 향상시키는 데 중요한 역할을 한다. 적절한 스레드 풀의 크기와 구성을 통해, 애플리케이션의 성능을 최적화할 수 있다. 스레드 풀의 최적화 전략을 수립하고 적용함으로써, 애플리케이션의 성능을 향상시킬 수 있다.

## DB 커넥션 풀 최적화 전략
- DB 커넥션 풀의 최적화 역시 애플리케이션의 성능에 중요한 영향을 미칩니다. DB 커넥션 풀의 크기가 너무 작으면 DB 연결 요청이 대기 상태에 빠질 수 있으며, 너무 크면 불필요한 자원 낭비가 발생할 수 있습니다. 따라서, DB 커넥션 풀의 크기를 애플리케이션의 요구 사항과 DB 서버의 성능에 맞게 조절하는 것이 중요합니다. 왜냐하면 DB 커넥션 풀의 크기는 DB 접근 성능과 직결되기 때문입니다. DB 커넥션 풀의 최적화를 위해서는 DB 접근 패턴을 분석하고, 커넥션 풀의 사용 상태를 모니터링하는 것이 필요합니다. 이를 통해 커넥션 풀의 크기를 동적으로 조절하거나, 커넥션 풀의 구성을 최적화할 수 있습니다.

### 질문
#### DB Connection Pool과 Thread Pool의 크기를 적절하게 조절하지 않으면 발생할 수 있는 주요 성능 문제는 무엇인가?
- DB Connection Pool이 작으면 스레드가 커넥션을 대기하면서 응답 지연이 발생하고, 반대로 Thread Pool이 작으면 웹 요청이 적시에 처리되지 않아 전체적인 응답 속도가 저하됩니다. 두 개의 풀 크기가 모두 크면 컨텍스트 스위칭 비용과 메모리 사용량 증가로 인해 성능이 저하될 수 있습니다.

#### HikariCP가 Connection을 할당하는 과정에서 기존 Connection을 우선적으로 반환하는 이유는 무엇인가?
- HikariCP는 이전에 사용된 Connection을 우선적으로 반환함으로써 커넥션의 재사용성을 높이고, 데이터베이스 연결에 걸리는 오버헤드를 줄여 성능을 최적화합니다. 이를 통해 새로운 커넥션을 생성하는 대신 기존 커넥션을 빠르게 제공하여 응답 속도를 향상시킵니다.


---

참고링크 

https://steady-coding.tistory.com/564

https://engineerinsight.tistory.com/197