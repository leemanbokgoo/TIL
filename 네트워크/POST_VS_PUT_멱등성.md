# 멱등성
![image](https://github.com/user-attachments/assets/c6eac13c-ffd1-4753-93e4-f2d1c7128bdb)

- 멱등이라는 단어의 뜻은 수학이나 전산학에서 연산을 여러번 적용하더라도 결과가 달라지지않는 성질을 의미.
- 위의 정의를 HTTP의 멱등성(Idempotent)에 대입해보자면, 멱등성이란 요청(Request)을 한 번을 호출하든 여러 번을 호출하든 그 결과가 같음을 의미한다. 즉, 동일한 요청을 한번 보내는 것과 여러번 연속으로 보내는 것이 같은 효과를 가지고, 서버의 상태도 동일하게 남을 때 해당 HTTP 메서드가 멱등성을 가진다고 말한다.

- 멱등의 개념을 안전(safe)과 혼동하기 쉬운데, HTTP 메소드의 안전이 한 번을 호출하든 여러 번을 호출하든 리소스에 수정이 발생하지 않는 속성,HTTP 메소드의 멱등은 리소스에 수정이 발생한다고 하더라도 메서드를 여러 번 실행한 결과가 한 번 실행한 결과와 같다면 만족하는 속성이라는 차이점이 있다. 또한 호출을 실행한 결과가 의미하는 것이 응답 상태 코드가 아닌 서버의 상태라는 점도 유의해야 한다. 예를들어 똑같은 요청을 했을 때 응답하는 상태코드가 다르더라도 서버의 상태가 같은 상태라면 멱등성이 있다고 판단하는 것이다

###  HTTP 메소드의 멱등성이 필요한 이유
- HTTP 멱등성이 필요한 이유는 요청의 재시도 때문이다. 만약 HTTP 요청이 멱등하다면, 요청이 실패한 경우에 주저없이 재시도 요청을 하면 된다. 하지만 만약 HTTP 요청이 멱등하지 않다면, 리소스가 이미 처리되었는데 중복 요청을 보낼 수 있다. 예를 들어 이미 결제된 요청인데, 중간에 연결이 끊겨서 다시 결제 요청을 보내서 문제를 일으킬 수 있는 것이다. 
- 그래서 클라이언트는 무지성으로 재시도 요청을 보내면 안되고, 멱등성을 고려하여 재시도 요청을 해야 한다.

### HTTP 메소드의 멱등 여부 
![image](https://github.com/user-attachments/assets/c823641c-92ef-47ad-b228-0f057c7ce12e)


## Post의 멱등
- 반대로 POST 메서드는 멱등을 만족하지 않는다.
- POST는 서버로 데이터를 전송하여 새로운 자원을 생성하는 역할을 한다. 따라서 요청을 여러번 보내는 경우 매번 새로운 자원이 생겨나는 것이며, 이는 서버의 상태가 변경되는 것을 의미한다. 

### 복구 메커니즘에 따져야 하는 멱등성
- 클라이언트가 서버에게 HTTP 메세지를 전송하였는데, TIMEOUT 과 같은 문제들로 인해 정상적인 응답을 전달받지 못했다고 가정해보자.
- 정상적인 응답을 받지 못했다면 다시 요청하면 그만이라고 생각하겠지만 여기에 HTTP의 멱등성의 유무가 들어가게 된다.
- 일반적으로 GET 이나 DELETE 같은 메서드들은 여러 번 호출하여도 응답 결과는 변함이 없기 때문에, 통신 장애 시 똑같은 요청을 재전송하도록 설계해도 문제는 없을 것이다. 
- 하지만 POST 와 같은 멱등하지 않게 설계된 메서드들은 똑같은 요청을 다시 전송할 경우 문제 발생 가능성 요지가 있다. 왜냐하면 통신 장애 이유가 서버 자체가 문제일수도 있고 아니면 인터넷 선이 문제일수도 있기 때문이다.

![image](https://github.com/user-attachments/assets/7806af7b-4eb2-4c2f-b4bf-c4d6b2c567ef)
- 만일 서버에서는 정상 처리했는데 응답 과정에서 네트워크 문제로 정상적인 응답을 받지 않았다면, POST를 재요청 해버리면 서버 입장에선 처리를 한 번 더 하게 되는 결과를 낳게 된다.
- 만일 이것이 돈과 관련된 결제와 같은 서비스라면 결제가 중복으로 되는 큰 문제로 직결된다.
- 따라서 POST 요청 같은 경우 더 큰 문제가 발생할 수 있기 때문에 요청을 또 보내는 것이 아닌 다른 조치를 취할 수 있도록 설계하는 것이 적절할 것이다.
- 이렇게 복구 매커니즘의 사용 가능 여부에 있어서 HTTP의 멱등적인 속성은 설계의 중심이 되게 된다.

## PUT의 멱등 (O)
- PUT 메서드는 대상 리소스를 덮어씌워 변경하거나, 대상 리소스가 없다면 새로 추가한다.
- 그래서 만일 대상 리소스가 없다면 PUT이 POST와 같은 동작을 하게 되는데, 반면 POST는 매번 새로운 자원을 만드는 반면, PUT은 해당 자원이 이미 있다면 데이터만 덮어쓴다.
- 따라서 요청을 한번하든 여러번하든 결국 서버의 상태는 같아지니, PUT은 멱등하다. 멱등하다고 해서 결과가 항상 같은것은 아님
- GET의 멱등 부분에서 소개했던 것 처럼 PUT도 예외 케이스가 있다. PUT 요청을 보냈는데, 새로운 데이터를 생성한 경우 201(Created) 상태코드를 응답하며, 기존 데이터를 덮어쓴 경우 200(OK) 혹은 204(No Content)를 응답하게 된다.
![image](https://github.com/user-attachments/assets/e29af96b-4985-44f6-8157-610b547a0b8f)

- 물론 다른 상태 코드를 응답한다고 해서 멱등 하지 않다는 것은 결코 아니다. 서버의 상태는 동일하므로 멱등성을 가진다고 할 수 있다.
- 다만 동일한 요청을 여러번 보내더라도 상태 코드라는 결과값이 다를수 있다는 점만 기억하면 된다.

### 질문
#### HTTP의 멱등성과 안전(safe)의 차이는 무엇인가요?
- HTTP 멱등성은 같은 요청을 여러 번 실행했을 때 서버의 상태가 동일하게 유지되는 속성을 말하며, 요청이 리소스를 수정하더라도 조건을 만족할 수 있습니다. 반면, 안전(safe)은 요청을 실행했을 때 리소스에 변경이 전혀 발생하지 않는 속성을 의미합니다. 예를 들어, GET은 안전하며 멱등성을 가지지만, DELETE는 멱등성을 만족하지만 안전하지 않습니다.
#### POST 요청이 멱등성을 가지지 않는 이유는 무엇이며, 이로 인해 발생할 수 있는 문제는 무엇인가요?
- POST 요청은 서버에 데이터를 전송해 매번 새로운 자원을 생성하거나 처리하기 때문에, 같은 요청을 여러 번 보내면 서버의 상태가 달라질 수 있습니다. 이러한 특성 때문에 네트워크 장애 등으로 클라이언트가 정상적인 응답을 받지 못했을 경우, POST 요청을 재전송하면 서버에서 동일한 작업이 중복으로 처리될 위험이 있습니다. 예를 들어, 결제 요청이 중복으로 처리되면 결제가 여러 번 이루어지는 심각한 문제가 발생할 수 있습니다. 따라서 POST 요청을 재전송하는 대신, 적절한 복구 메커니즘을 설계해야 합니다.

----
출처  

https://inpa.tistory.com/entry/WEB-🌐-HTTP의-멱등성-·-안정성-·-캐시성-💯-완벽-이해하기 [Inpa Dev 👨‍💻:티스토리]

https://mangkyu.tistory.com/251