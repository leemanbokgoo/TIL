## Test와 Redis
- 로컬 레디스를 사용해서 테스트를 하는 경우에는 로컬에 레디스가 깔려 있어야만 테스트가 돌아가는 문제가 있다. 테스트는 어떤 환경에서든 돌아가야한다. 그렇기때문에 레디스를 테스트하기 위한 환경을 어플리케이션 내에서 구축 하여 추가적으로 테스트를 위해 프로그램을 설치할 필요가 없도록 설정해두는 것이 좋다.
- Redis를 test환경에서 사용하기위해서는 임베디드 Redis 라이브러리 혹은 TestContainer를 사용 할 수 있다. 

## Embedded Redis
- Embedded Redis는 주로 테스트 환경에서 실제 Redis 서버 없이도 Redis 기능을 사용할 수 있도록 해주는 경량화된 서버 구현체이다. Java(Spring) 애플리케이션에서 단위 테스트나 통합 테스트 시 Redis 의존성을 해결하고 테스트를 보다 쉽게 만들기 위해 자주 사용된다.
- Java 애플리케이션 내에서 Redis 서버를 프로세스처럼 실행시켜주는 테스트 도구이다.

### 장점
- 외부 Redis 인스턴스가 불필요하다. CI 환경이나 로컬 테스트에서 별도의 Redis 서버 없이 테스트가 가능하여 독립적인 테스트를 보장 할 수 있다. 
- 테스트마다 Embedded Redis 인스턴스를 새로 띄움으로써 상태 충돌이 없다.
- 설정이 간편하다.
- GitHub Actions, Jenkins 등에서 Redis 설치 없이 테스트 수행 가능하다.

### 단점 
- 운영체제 의존성 : Redis는 C로 작성된 바이너리를 실행하기 때문에 OS에 따라 동작 여부가 다를 수 있다. Windows에서는 기본적으로 동작하지 않거나, 별도 설정 필요하다 (Windows용 Redis 바이너리 없음)
- 실제 Redis와의 차이가 있다. 일부 최신 Redis 기능(예: Redis 6 이상의 ACL, TLS 등)은 지원되지 않으며 메모리, 스레드, 퍼포먼스 측면에서도 한계가 있다.
- 버전 관리가 어렵다. 내부적으로 사용하는 Redis 바이너리 버전이 고정되어 있어 최신 Redis 기능 테스트가 어렵다.
- 비공식 라이브러리로 embedded-redis는 Redis 공식 라이브러리가 아니며, 유지보수가 활발하지 않을 수 있다. 일부 라이브러리는 오래되었고, Java 17 이상에서는 호환 문제가 발생하기도 한다.
- TestContainer에 비해 덜 경량화된 방식일 뿐더러 계속되는 버전 변경점에 취약하다는 단점이 있다. 

### 주의할 점
- Embedded Redis의 경우 오픈소스 개발이 중단되어 m1칩의 경우 지원이 안된다. 그래서 개발이 중단 됐던 kstyrc/embedded-redis를 fork해서 개발하다가 개발이 중단됐던 ozimove/embedded-redis를 fork해서 개발하고 있는 codemonstur/embedded-redis라는 라이브러리가 있다. 해당 라이브러리를 사용해야 m1 칩에서 테스트가 가능하다.
    - https://github.com/codemonstur/embedded-redis

## Testcontainers
- 테스트 위해 Java 언어만으로 docker container를 실행시켜주는 자바 라이브러리로  Docker Container를 활용한 일회용 인스턴스를 제공하는 JUnit 테스트 라이브러리다. 쉽게 말해서 테스트를 위해 Docker Container 를 실행시켜주는 자바 라이브러리다. 도커를 이용하여 테스트 할때 컨테이너를 직접 관리해야하는 번거로움 해결해주며 운영 환경과 유사한 스펙으로 테스트 가능하다.
- Testcontainers 활용하면 단순히 테스트 실행만으로 특정 컨테이너가 실행되어 테스트를 진행하고 모든 테스트가 끝나면 컨테이너도 자동으로 종료된다. 컨테이너로 동작하기 때문에 어느 환경에서든 바로 실행이 가능하다.

### Testcontainers 장점
- 떠한 사전 준비도 필요없이 단순 테스트 실행만으로 redis 컨테이너가 실행되어 테스트를 진행하고 모든 테스트가 끝나면 컨테이너도 자동으로 종료된다. 테스트 환경 이외에 다른 환경에 존재하는 Redis 캐싱 메모리와 충돌되는 문제도 없다. 
- 실제 Redis 이미지 사용하기 때문에 Redis의 최신 버전, 공식 기능을 포함한 진짜 Redis가 컨테이너로 실행된다.
- 운영 환경도 Docker를 사용한다면 거의 동일한 환경에서 테스트 가능하다.
- 다양한 테스트를 지원하기때문에 Redis뿐 아니라 Kafka, RabbitMQ, MySQL 등 여러 인프라를 동시에 컨테이너로 띄울 수 있다.
- OS 독립적이다. Docker만 설치되어 있다면 Windows, Linux, macOS 모두 지원된다.
- 테스트 종료 시 컨테이너 자동 종료 및 리소스 해제한다.

### Testcontainers 단점
- Docker가 필수적이기때문에 Desktop이나 Docker 엔진이 설치되어 있어야 한다. CI 환경에서도 Docker 권한 필요하다.
- Redis 컨테이너를 풀로 띄우므로 Embedded Redis보다 시작이 느리다. (수 초 이상)
- 로컬 자원 많이 사용한다. 컨테이너 기동 시 메모리/CPU 리소스 소모 크다.
- 초기 설정 복잡하다. 테스트에 맞게 포트, 볼륨, 네트워크 설정 등 추가 설정이 필요할 수 있다.


## Embedded Redis와 Testcontainers의 트레이드 오프 
-  Embedded Redis는 Java 애플리케이션 안에서 Redis를 내장 서버처럼 직접 실행할 수 있도록 해주는 경량화 도구이다. 바이너리를 다운로드하여 로컬에서 직접 실행하므로 설정이 간편하고 실행 속도가 매우 빠르다. 단위 테스트나 간단한 기능 테스트에 적합하며, Docker나 별도의 Redis 설치 없이도 테스트 환경을 구성할 수 있다는 점이 큰 장점이다.
- 반면 Testcontainers는 실제 Redis Docker 이미지를 기반으로 컨테이너를 띄워 테스트를 진행한다. 따라서 실제 운영 환경과 거의 동일한 Redis 환경을 제공할 수 있어 실제와 유사한 조건에서 테스트를 해야 하는 경우나 Redis의 특정 버전을 명시적으로 테스트하고 싶을 때 매우 유리하다. 컨테이너는 격리된 환경에서 실행되기 때문에 병렬 테스트 수행이나 port 충돌 방지에도 유리하다. 하지만 컨테이너를 띄우는 데 시간이 더 걸리고, Docker가 필수로 설치되어 있어야 하며, 설정도 Embedded Redis보다는 복잡한 편이다.
- Embedded Redis는 속도와 단순성에서 뛰어나며,  간편하고 빠르지만 제한적인 환경, 간단한 단위 테스트에 적합하고 Testcontainers는 운영환경과 유사한 테스트가 가능하며,무겁고 느릴 수 있지만 운영 환경에 가까운 리얼한 테스트 환경을 제공하므로 통합 테스트나 복잡한 시나리오에 적합하다.


### 질문
#### Embedded Redis와 Testcontainers 중 어떤 것을 선택하시겠습니까? 각각의 사용 기준은 무엇인가요?
- Embedded Redis는 설정이 간편하고 테스트 실행 속도가 빠르기 때문에, 단위 테스트나 간단한 캐시 로직 검증처럼 빠른 피드백이 필요한 테스트에서 적합하다고 판단됩니다. 반면에 Testcontainers는 실제 Redis 컨테이너를 실행하기 때문에 Redis의 최신 버전이나 운영 환경과 동일한 조건에서 테스트해야 할 경우에 적합합니다. 예를 들어 CI 환경이나 다양한 인프라를 연동한 통합 테스트에서는 Testcontainers를 사용하는 것이 바람직하다고 생각합니다. 따라서 테스트의 목적과 환경에 따라 두 도구를 선택적으로 혹은 병행해서 사용하는 전략이 현실적인 선택이라고 생각합니다.

### Embedded Redis의 주요 단점은 무엇이며, 이를 해결하거나 보완할 수 있는 방법은 있나요?
- Embedded Redis의 주요 단점은 운영체제 의존성과 공식 지원이 없는 비공식 라이브러리라는 점입니다. 특히 macOS M1 환경이나 Java 17 이상에서는 호환성 문제가 발생할 수 있습니다. 이를 해결하기 위해서는 현재도 유지보수가 이루어지고 있는 codemonstur/embedded-redis와 같은 fork된 라이브러리를 사용하는 것이 좋습니다. 하지만 이러한 구조적 한계 때문에, 운영 환경과의 완벽한 테스트를 보장할 수 없다는 점은 항상 인식하고, 필요 시 Testcontainers로 전환하거나 병행 사용하는 것이 바람직하다고 생각합니다.


---

참고링크 

https://loosie.tistory.com/813

https://giron.tistory.com/146

https://7357.tistory.com/390