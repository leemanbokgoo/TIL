# 데이터 분산
- 데이터를 한 곳에 보관하면 정보 관리 측면에선 좋을 수 있지만, 여러 가지 문제가 발생할 수 있다.
- 데이터가 늘어나면 데이터 베이스의 용량 이슈도 생기고, 느려지는 CRUD는 자연스레 서비스 성능에 영향을 주게 된다. 때문에 전략적으로 데이터를 분산화해서 관리해야한다.
- 데이터베이스 분산 전략은 몇 가지 있다.
    - 복제(Replication) : 전체 데이터베이스 또는 그 하위 집합을 여러 서버에 복사하여 각 서버가 읽기 요청을 독립적으로 처리할 수 있도록 분산. 한 서버의 데이터에 대한 모든 변경 사항은 다른 서버로 전파하여 처리한다.
    - 페더레이션(Federation) : 사용자 기반의 서로 다른 부분을 제공하는 여러 개의 작은 데이터베이스로 구성된 데이터베이스 생성
    - 파티셔닝(Partitioning), 샤딩(Sharding) : 데이터베이스를 작은 부분으로 나누어 분산 저장하는 방식
- 위 두 가지는 일반적으로는 잘 사용되지 않는다. 파티셔닝과 샤딩이 자주 사용되는 전략인데, 단일 DB에서는 파티셔닝도 자주 사용되고, 물리적으로 분리된 환경에서는 샤딩이 주로 사용된다.

## 파티셔닝
- 파티셔닝이란 기본적으로 매우 큰 테이블을 여러개의 테이블로 분할하는 작업이다. 큰 데이터를 여러 테이블로 나눠 저장하기때문에 쿼리 성능이 개선될수 있다. 이때 데이터는 물리적으로 여러 테이블로 분산하여 저장되지만 사용자는 마치 하나의 테이블에 접근 하는 것과 같이 사용할 수 있다는 것이 특징. 
- 파티셔닝은 MySQL단에서 자체적으로 지원하는 기능

## 파티셔닝 목적
- 성능 
    - 특정 DM과 Query의 성능을 향상시킨다. 주로 대용량 date write 환경에서 효율적
    - 특히 풀 스캔에서 데이터 접근 범위를 줄여 성능 향상을 가져온다
    - 많은 insert가 있는 OLTP시스템에서 insert작업을 작은 단위인 partition들로 분산시켜 경합을 줄인다
- 가용성
    - 물리적인 파티셔닝으로 인해 전체 데이터의 훼손가능성이 줄어들고 데이터 가용성이 향상된다. 각 분햘 영역(파티션별로) 독립적으로 백업하고 복구 할 수 있다. table의 partition단위로 디스크 I/O를 분산하여 경합을 줄이기때문에 update 성능을 향상시킨다
- 관리 용이성
    - 큰 테이블들을 제거하여 관리를 쉽게 해준다

## 장단점
#### 관리적 측면 : partition 단위 백업, 추가, 삭제, 변경
- 전체 데이터를 손실할 가능성이 줄어들어 데이터 가용성이 향상된다.
- partition별로 백업 및 복구가 가능하다.
- partition 단위로 I/O 분산이 가능하여 UPDATE 성능을 향상시킨다.
#### 성능적 측면 : partition 단위 조회 및 DML수행
- 데이터 전체 검색 시 필요한 부분만 탐색해 성능이 증가한다. 즉, Full Scan에서 데이터 Access의 범위를 줄여 성능 향상을 가져온다.
- 필요한 데이터만 빠르게 조회할 수 있기 때문에 쿼리 자체가 가볍다.

## DB 파티셔닝(Partitioning)의 종류
### 수평 파티셔닝
![image](https://github.com/user-attachments/assets/9884d770-bcf3-4e9f-9a36-e6fdbee6507d)
- 하나의 테이블의 각 행을 다른 테이블에 분산 시키는 것이다. 
- 퍼포먼스 , 가용성을 위해 key 기반으로 여러곳에 분산 저장한다.
- 일반적으로 분산 저장 기술에서 파티셔닝은 수평분할을 의미한다. 보통 수평 분할을 한다고 헀을 때에는 하나의 데이터 베이스안에서 이루어지는 경우를 지칭한다.
### 장단점
#### 장점
- 데이터의 갯수를 기준으로 나누어 파티셔닝한다.
- 데이터의 갯수가 작아지고 따라서 인덱스의 갯수도 작아지게 된다 -> 성능향상

#### 단점
- 서버간의 연결과정이 많아진다
- 데이터를 찾는 과정이 기존보다 복잡 -> 레이턴시가 증가하게된다.
- 하나의 서버가 고장나게 되면 데이터의 무결성이 깨질 수 있음.

### 수직 파티셔닝
![image](https://github.com/user-attachments/assets/b64545b8-791b-4424-9634-9edb3963d388)
- 테이블의 일부 열을 빼내는 형태로 분할한다. 정규화도 수직 파티셔닝과 관련된 과정이라고 할 수 있다. 하지만 수직 파티셔닝은 이미 정규화된 테이블을 분리하는 과정이라고 생각해야함.
- 관계형 DB에서 3 정규화 같은 개념으로 접근하면 이해하기 쉽다. 하지만 수직 파티셔닝은 이미 정규화된 데이터를 분리하는 과정이다.

### 장단점
#### 장점
- 자주 사용하는 칼럼등을 분리시켜 성능 향상 가능
- 한 테이블을 SELECT하면 결국 모든 컬럼을 메모리에 올리게 되므로 필요없는 컬럼까지 올라가서 한 번에 읽을 수 있는 ROW가 줄어든다. 이는 I/O 측면에서 봤을 때 필요한 컬럼만 올리면 훨씬 많은 수의 ROW를 메모리에 올릴 수 있으니 성능상의 이점이 있다.
- 같은 타입의 데이터가 저장되기 때문에 저장 시 데이터 압축률을 높일 수 있다.
#### 단점
- 데이터를 찾는 과정이 기존보다 복잡하므로 Latency가 증가한다.


## 샤딩(Sharding)
![image](https://github.com/user-attachments/assets/ee5f3849-74d2-40a6-b864-926d6a9f6406)

- 데이터베이스 샤딩은 대규모 데이터베이스를 샤드(Shard)라고 하는 더 작고 관리하기 쉬운 조각으로 수평 분할해 데이터를 보관하는 방식이다.각 샤드는 별도의 물리적 서버에 저장되며 데이터의 하위 집합을 포함한다.
- 샤딩은 데이터를 분산 시킴으로서 여러대의 서버를 사용하고 병렬로 처리함으로서 확장성과 성능을 향상 시킬 수 있다.
- 샤딩은 수평 파티셔닝의 일종으로 볼수있다. 그러나 수평적 파티셔닝은 동일한 DB서버내에 테이블을 분할하는 것이고 샤딩은 DB서버를 분할한다는 것. 즉, 샤딩은 DB서버의 부하를 분산 할 수 있다는 것이고 샤딩은 데이터 베이스 차원의 수평확장인 셈.
- 데이터를 물리적으로 독립된 데이터베이스에 각각 분할하여 저장하므로, 여러 샤드에 걸친 데이터를 조인하는 것이 어렵다. 또한, 한 데이터베이스에 집중적으로 데이터가 몰리면 Hotspot이 되어 성능이 느려진다. 따라서 데이터를 여러 샤드로 고르게 분배하는 것이 중요하다.
- 대규모 분산 데이터베이스 시스템에서 데이터를 수평으로 분할하여 여러 서버에 분산 저장하는 기술입. 이 방법은 데이터베이스의 성능과 확장성을 향상시키는 데 중요한 역할을 한다.
- 왜냐하면 샤딩을 통해 데이터베이스의 부하를 여러 서버로 분산시킬 수 있기 때문. 각 샤드는 독립적으로 운영되며, 전체 데이터베이스 시스템의 처리량과 성능을 향상시킨다
- 데이터베이스 샤딩은 주로 대용량 데이터를 처리해야 하는 웹 애플리케이션, 소셜 네트워크 서비스, 온라인 게임 등에서 사용된다. 이는 데이터베이스의 확장성 문제를 해결하고, 시스템의 안정성을 보장하는 데 기여함.
- 샤딩의 핵심은 샤드 키(Shard Key)를 어떻게 선택하느냐에 있다. 샤드 키는 데이터를 분할하고 분산 저장하는 기준이 되며, 샤딩의 성능과 효율성을 결정짓는 중요한 요소이다..
- 데이터베이스 샤딩은 데이터의 분산 저장을 통해 단일 데이터베이스 서버의 성능 한계를 극복하고, 시스템의 확장성과 처리량을 크게 향상시킬 수 있다.

### 샤딩의 장점
- Scale_out이 가능
- 스캔 범위를 줄여 쿼리 반응 속도를 빠르게 함. 
- 시스템의 확장성과 성능향상 -> 분산 저장을 통해 단일서버에 집중되는 부하 줄이고 전체 시스템의 처리량을 증가 시킬 수 있다.
- 장애가 샤드 단위로 발생함 -> 시스템의 안정성과 가용성을 향상 시킴
- 데이터 베이스의 읽기와 쓰기 성능을 개선할 수 있다. 데이터가 여러 서버에 분산되어있기때문에 병렬처리 가능 -> 결과적으로 데이터 베이스의 응답시간이 단축됨
- 데이터 베이스의 유지보수와 관리를 용이하게 함 -> 데이터가 분산되어있기때문에 특정 샤드의 백업, 복구, 업그레이드 작업이 다른 샤드에 영향을 미치지않음.

### 샤딩의 단점
- 프로그래밍 복잡도 증가
- 데이터가 한 쪽 샤드로 몰릴 경우(HotSpot), 샤딩이 무의미해짐
- 잘못 사용할 경우 리스크가 큼.
- 한변 샤딩 사용시 사딩을 사용하기 이전의 구조로 돌아가기 힘듬.


## 샤딩의 종류
### 모듈러 샤딩
![image](https://github.com/user-attachments/assets/5ec6f73c-72ce-4b71-96aa-606530bbe652)
- PK를 모듈러로 연산한 결과로 DB를 라우팅하는 방식
- 레인저 샤딩에 비해 데이터가 균일하게 분산된다.
- DB를 추가 증설하는 과정에서 이미 적재된 데이터의 재정렬이 필요하다.
- 데이터가 일정 수준에서 예상되는 데이터 성격을 가진 곳에 적용할 떄 적합하다. 데이터가 늘어남에 따라 샤딩을 추가적으로 해야하는 상황이 자주 생기면 큰 부하가 발생하기때문.
- 데이터가 균일하게 분산된다는 점은 트래픽을 안정적으로 소화하면서도 DB리소스를 최대한 활용할 수 있다는 것을 의미한다. 

### 레인지 샤딩
![image](https://github.com/user-attachments/assets/eba43e99-1e81-4947-a3f5-ec3e93e5b97a)
- PK의 범위를 기준으로 DB를 특정하는 방식.
- 모듈러 샤딩에 비해 기본적으로 증설에 재정렬 비용이 들지 않는다. 일부 DB에 데이터가 몰릴 수 있다.
- 레인지 샤딩의 가장 큰 장점은 증설 작업에 드는 큰 비용이 들지 않는다는 점이다. 데이터가 급격히 증가할 여지가 있다면 레인지 방식은 좋은 선택이 될 것이다.
- 다만 활성 유저가 몰린 DB로 트래픽이나 데이터량이 몰릴 수 있다. 그러면 또 몰리는 DB는 분산시키고 트래픽이 저조한 DB는 통합시키는 과정이 필요하다. 따라서 적절한 Range 기준을 잡는 것이 중요하다.

### 디렉토리 샤딩
![image](https://github.com/user-attachments/assets/fffe16bf-e642-47f7-8bda-69c0dc6317cc)
- 별도의 조회 테이블을 사용해서 샤딩을 하는 경우다.
- 샤딩에 사용되는 시스템이나 알고리즘을 사용할 수 있다.
- 샤드를 동적으로 추가하는 것도 비교적 쉽다.
- 모든 읽기 및 쓰기 쿼리 전에 조회 테이블을 참조해야 하므로 오버헤드가 발생한다.

## 그럼 분산 환경을 사용하면 무조건 좋나요?
- 복잡성 증가(Increased complexity): DB 분산은 데이터베이스 인프라에 복잡성을 추가하여 유지 및 관리가 어려워진다. 데이터가 적절하게 분산 및 복제되도록 관리자가 분산 전략을 잘 수립해야한다.
- 데이터 일관성(Data consistency): 데이터가 여러 경로로 분할되기 때문에 데이터 일관성 문제를 일으킬 수 있다. 애플리케이션은 데이터 수정이 모든 DB에서 적절하게 동기화되도록 해야 하며 이는 어려울 수 있다.
- 제한된 유연성(Limited flexibility): 수정된 스키마가 모든 분산환경에 동시에 반영되어야 하므로 새로운 기능을 추가하기 어렵게 만듭니다. 스키마를 변경하려면 분산 전략을 수정해야 할 수 있으며 이는 시간이 많이 걸리고 복잡할 수 있다.
- 전반적으로 데이터베이스 분산 전략은 확장성과 성능 측면에서 상당한 이점을 제공할 수 있지만 추가적인 복잡성과 관리 오버헤드도 발생하므로, 장단점을 신중하게 평가하여 필요에 맞는 솔루션인지 판단해서 적용해야한다.

### 질문
##### 파티셔닝과 샤딩의 주요 차이점은 무엇인가요?
- 파티셔닝과 샤딩은 둘 다 데이터를 분할해서 성능과 확장성을 높이기 위한 기법입니다.
파티셔닝은 보통 단일 데이터베이스 내에서 테이블을 논리적으로 나누는 방식으로, 수평 파티셔닝은 데이터를 행 단위로, 수직 파티셔닝은 컬럼 단위로 나눕니다. 예를 들어 고객 ID 범위에 따라 테이블을 나누는 식입니다. 반면 샤딩은 더 큰 개념으로, 데이터를 여러 데이터베이스 서버에 물리적으로 분산시키는 방식입니다. 예를 들어 사용자 ID를 해시해서 서로 다른 DB 서버에 저장함으로써 부하를 나누고 병목을 줄일 수 있습니다. 즉, 파티셔닝은 주로 단일 DB 내에서 이루어지는 반면, 샤딩은 여러 DB 인스턴스를 활용해 수평 확장을 가능하게 만든다는 점에서 차이가 있습니다. 샤딩은 부하 분산과 확장성을 강화할 수 있는 반면, 파티셔닝은 주로 단일 서버에서 데이터의 관리 및 접근 효율성을 높이기 위해 사용됩니다.

#### 샤딩의 단점 중 트랜잭션 관리의 어려움을 극복하기 위한 방법은 무엇인가요?
- 샤딩에서 트랜잭션 관리를 극복하기 위해 주로 2PC(Two-Phase Commit) 또는 SAGA 패턴과 같은 기법이 사용됩니다. 2PC는 분산 트랜잭션의 일관성을 보장하지만 복잡하고 느릴 수 있으며, SAGA 패턴은 보상 트랜잭션을 통해 분산 환경에서 더 유연한 트랜잭션 관리를 제공합니다.

---

출처 링크 

https://hudi.blog/db-partitioning-and-sharding/

https://s7won.tistory.com/13

https://velog.io/@kyeun95/%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%B2%A0%EC%9D%B4%EC%8A%A4-%ED%8C%8C%ED%8B%B0%EC%85%94%EB%8B%9DPartitioning%EC%9D%B4%EB%9E%80


https://velog.io/@kyeun95/%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EC%83%A4%EB%94%A9Sharding%EC%9D%B4%EB%9E%80

https://f-lab.kr/insight/understanding-database-sharding