# 데이터 분산
- 데이터를 한 곳에 보관하면 정보 관리 측면에선 좋을 수 있지만, 여러 가지 문제가 발생할 수 있다.
- 데이터가 늘어나면 데이터 베이스의 용량 이슈도 생기고, 느려지는 CRUD는 자연스레 서비스 성능에 영향을 주게 된다. 때문에 전략적으로 데이터를 분산화해서 관리해야한다.
- 데이터베이스 분산 전략은 몇 가지 있다.
    - 복제(Replication) : 전체 데이터베이스 또는 그 하위 집합을 여러 서버에 복사하여 각 서버가 읽기 요청을 독립적으로 처리할 수 있도록 분산. 한 서버의 데이터에 대한 모든 변경 사항은 다른 서버로 전파하여 처리한다.
    - 페더레이션(Federation) : 사용자 기반의 서로 다른 부분을 제공하는 여러 개의 작은 데이터베이스로 구성된 데이터베이스 생성
    - 파티셔닝(Partitioning), 샤딩(Sharding) : 데이터베이스를 작은 부분으로 나누어 분산 저장하는 방식
- 위 두 가지는 일반적으로는 잘 사용되지 않는다. 파티셔닝과 샤딩이 자주 사용되는 전략인데, 단일 DB에서는 파티셔닝도 자주 사용되고, 물리적으로 분리된 환경에서는 샤딩이 주로 사용된다.

## 파티셔닝
- 파티셔닝이란 기본적으로 Database Table을 더 작은 Table로 나누는 것을 의미합니다. 파티셔닝은 크게 두 가지 종류로 나눌 수 있습니다.
- 파티셔닝은 더 쉬운 관리와 더 빠른 액세스를 위해 데이터베이스를 더 작은 부분으로 나눈다. 그러나 샤딩과 달리 행이 아닌 데이터 열을 구분하는 수직 분할이 포함된다.
- 예를 들어 고객 데이터베이스는 가장 자주 액세스되는 열(예: 이름, 이메일, 전화 번호)을 한 파티션에 유지하고 덜 액세스되는 열(예: 주소, 주문 내역)을 다른 파티션에 유지하여 분할할 수 있다.
- 수평 파티셔닝은 샤딩과 유사하지만, 파티셔닝은 단일 DB에서 주로 사용된다는 점에서 차이가 있다.
- 파티셔닝은 매우 큰 테이블을 여러개의 테이블로 분할하는 작업이다. 큰 데이터를 여러 테이블로 나눠 저장하기 때문에 쿼리 성능이 개선될 수 있다. 이때, 데이터는 물리적으로 여러 테이블로 분산하여 저장되지만, 사용자는 마치 하나의 테이블에 접근하는 것과 같이 사용할 수 있다는 점이 특징이다. 파티셔닝은 MySQL 단에서 자체적으로 지원하는 기능이다.

## 샤딩(Sharding)
- 데이터베이스 샤딩은 대규모 데이터베이스를 샤드(Shard)라고 하는 더 작고 관리하기 쉬운 조각으로 수평 분할해 데이터를 보관하는 방식이다.
- 각 샤드는 별도의 물리적 서버에 저장되며 데이터의 하위 집합을 포함한다.
- 그림을 잘 보아야하는게 한 DB에 있는 데이터가 두 DB로 분리되었다.
- 분리된 DB에 저장된다는 점이, 수평 파티셔닝은 한 DB 내에서 처리되는 것과의 차이다.
- 샤딩의 주요 목표는 대규모 데이터베이스의 성능과 확장성을 개선하는 것이다.
- 여러 서버에 데이터를 분산하면 쿼리를 병렬로 실행할 수 있으므로 응답 시간이 빨라지며, 각 샤드의 크기가 작기 때문에 데이터를 더 쉽게 관리하고 백업할 수 있다는 장점도 있다.
- 샤딩은 앞에서 보았던 Horizontal Partitioning과 굉장히 유사해요. 실제로 동작 자체도 동일하게 이루어집니다. 즉, row를 기준으로 테이블을 나누게 됩니다. Horizontal Partitioning과의 큰 차이점은 각각의 Partition들이 독립된 DB 서버에 저장된다는 점입니다.
- 위에서 보았던, Subscription_0, Subscription_1, Subscription_2, Subscription_3들은 Horizontal Partitioning에서는 같은 DB 서버에 저장됩니다. 이러한 방식은, 하나의 컴퓨터(서버)에 저장이 되기 때문에 백엔드로부터 많은 요청이 발생하면 어떤 Partition에 대한 요청이던 한 서버의 cpu와 memory를 사용해서 요청을 처리하게 됩니다. 즉, 하드웨어 자원이 한정되어 있습니다.
- 이를 샤딩에서는 각각 다른 서버에 저장하는 거에요. 이 경우에는, 백엔드로부터 많은 요청이 들어와도, 각각 Partition에 해당하는 DB 서버가 존재하기 때문에 부하를 분산시키는 효과를 가질 수 있습니다.
- 요약하면, 샤딩은 각 Partition을 서로 다른 DB 서버에 저장해서 부하를 분산시키고자 하는 방식입니다.
- 규모가 큰 서비스, 데이터가 많이 쌓이는 테이블, 트래픽이 많이 몰리는 테이블은 이런 식으로 샤딩을 활용하여 각 Partition 마다 독립된 DB 서버를 할당하고, 이를 통해 트래픽을 분산시켜 DB 서버의 부하를 낮출 수 있습니다. 이러한 샤딩의 경우에는, 위에서 Partition key라고 부르던 것을 Shard key라고 부르고, 각 Partition을 Shard라고 부릅니다.
- 서버에 여유만 있다면, 샤딩은 매우 좋은 방식 같아보이고 실제로도 그렇습니다. 하지만 고려해야 할 부분은 트랜잭션에 관한 부분이에요. 다른 DB 서버에 데이터들이 존재하기 때문에, 트랜잭션 관리가 실제로 많이 복잡해집니다. 이를 위해 2PC, SAGA 패턴 등 다양한 방법들이 존재합니다. 이 부분에 대해서는 MSA를 적용해보면서 조금 더 학습하고 작성해 보겠습니다.
- 샤딩은 동일한 스키마를 가지고 있는 여러대의 데이터베이스 서버들에 데이터를 작은 단위로 나누어 분산 저장하는 기법이다. 이때, 작은 단위를 샤드(shard)라고 부른다.
- 어떻게 보면 샤딩은 수평 파티셔닝의 일종이다. 차이점은 파티셔닝은 모든 데이터를 동일한 컴퓨터에 저장하지만, 샤딩은 데이터를 서로 다른 컴퓨터에 분산한다는 점이다. 물리적으로 서로 다른 컴퓨터에 데이터를 저장하므로, 쿼리 성능 향상과 더불어 부하가 분산되는 효과까지 얻을 수 있다. 즉, 샤딩은 데이터베이스 차원의 수평 확장(scale-out)인 셈이다.
- 샤딩은 위와 같이 물리적으로 분산된 환경에서 사용되는 기법으로 데이터베이스 차원이 아닌 애플리케이션 레벨에서 구현하는 것이 일반적이다. 다만 샤딩을 플랫폼 차원에서 제공하는 시도가 많다고 한다. Naver d2 포스팅에 따르면, Hibernate Shards와 같이 애플리케이션 서버에서 동작하는 형태, CUBRID SHARD, Spock Proxy, Gizzard 와 같이 미들 티어(middle tier)에서 동작하는 형태, nStore나 MongoDB와 같이 데이터베이스 자체에서 샤딩을 제공하는 형태로 나뉜다고 한다.



## 그럼 분산 환경을 사용하면 무조건 좋나요?
- 복잡성 증가(Increased complexity): DB 분산은 데이터베이스 인프라에 복잡성을 추가하여 유지 및 관리가 어려워진다. 데이터가 적절하게 분산 및 복제되도록 관리자가 분산 전략을 잘 수립해야한다.
- 데이터 일관성(Data consistency): 데이터가 여러 경로로 분할되기 때문에 데이터 일관성 문제를 일으킬 수 있다. 애플리케이션은 데이터 수정이 모든 DB에서 적절하게 동기화되도록 해야 하며 이는 어려울 수 있다.
- 제한된 유연성(Limited flexibility): 수정된 스키마가 모든 분산환경에 동시에 반영되어야 하므로 새로운 기능을 추가하기 어렵게 만듭니다. 스키마를 변경하려면 분산 전략을 수정해야 할 수 있으며 이는 시간이 많이 걸리고 복잡할 수 있다.
- 전반적으로 데이터베이스 분산 전략은 확장성과 성능 측면에서 상당한 이점을 제공할 수 있지만 추가적인 복잡성과 관리 오버헤드도 발생하므로, 장단점을 신중하게 평가하여 필요에 맞는 솔루션인지 판단해서 적용해야한다.

### 질문
##### 파티셔닝과 샤딩의 주요 차이점은 무엇인가요?
- 파티셔닝은 단일 데이터베이스 내에서 데이터를 나누어 저장하는 반면, 샤딩은 데이터를 서로 다른 물리적 데이터베이스 서버에 분산하여 저장합니다. 따라서 샤딩은 부하 분산과 확장성을 강화할 수 있는 반면, 파티셔닝은 주로 단일 서버에서 데이터의 관리 및 접근 효율성을 높이기 위해 사용됩니다.

#### 샤딩의 단점 중 트랜잭션 관리의 어려움을 극복하기 위한 방법은 무엇인가요?
- 샤딩에서 트랜잭션 관리를 극복하기 위해 주로 2PC(Two-Phase Commit) 또는 SAGA 패턴과 같은 기법이 사용됩니다. 2PC는 분산 트랜잭션의 일관성을 보장하지만 복잡하고 느릴 수 있으며, SAGA 패턴은 보상 트랜잭션을 통해 분산 환경에서 더 유연한 트랜잭션 관리를 제공합니다.

---

출처 링크 

https://hudi.blog/db-partitioning-and-sharding/

https://s7won.tistory.com/13